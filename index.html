<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1JXBVGTYY7"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-1JXBVGTYY7');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RareShop - Laptops, Phones, TVs & More</title>

    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dqr2ewypl/image/upload/v1762613482/ChatGPT_Image_Nov_8_2025_07_51_53_PM_lorjo6.png">
    <link rel="apple-touch-icon" href="https://res.cloudinary.com/dqr2ewypl/image/upload/v1762613482/ChatGPT_Image_Nov_8_2025_07_51_53_PM_lorjo6.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        /* Custom scrollbar (optional) */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* --- Custom Animations --- */

        /* 1. Subtle Fade In for Hero Banner */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }

        /* 2. Slide In for Section Titles */
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-up {
            opacity: 0; /* Ensures it starts hidden */
            animation: slideInUp 0.5s ease-out forwards;
        }
        
        /* 3. Product Card Hover Lift (using transition/transform utility in HTML) */
        .product-card-animation:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Style for displaying discounted price */
        .original-price {
            text-decoration: line-through;
            color: #9ca3af; /* gray-400 */
            font-size: 0.875rem; /* text-sm */
        }
        .discount-price {
            font-weight: 700;
            color: #ef4444; /* red-500 */
        }

        /* --- Carousel Styles --- */
        .carousel-container {
            position: relative;
            overflow: hidden;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
        }
        .carousel-track {
            display: flex;
            transition: transform 0.5s ease-in-out;
        }
        .carousel-slide {
            min-width: 100%;
            position: relative;
            cursor: pointer;
        }
        .carousel-slide img,
        .carousel-slide .carousel-slide-placeholder { /* Target placeholder */
            width: 100%;
            display: block;
            object-fit: cover;
            aspect-ratio: 3 / 1; /* Example: 3:1 aspect ratio */
            background-color: #e5e7eb; /* bg-gray-200 */
        }
        .carousel-dots {
            position: absolute;
            bottom: 0.75rem; /* bottom-3 */
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 0.5rem; /* space-x-2 */
        }
        .carousel-dot {
            width: 0.75rem; /* w-3 */
            height: 0.75rem; /* h-3 */
            border-radius: 9999px; /* rounded-full */
            background-color: rgba(255, 255, 255, 0.5); /* bg-white/50 */
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .carousel-dot.active {
            background-color: rgba(255, 255, 255, 1); /* bg-white */
        }
        /* --- END Carousel Styles --- */
        
        /* --- Sale Timer Styles --- */
        .detail-sale-timer {
            background-color: #fffbeb; /* amber-50 */
            border: 1px solid #fde68a; /* amber-200 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.75rem 1rem; /* p-3 sm:p-4 */
            text-align: center;
        }
        .detail-sale-timer-title {
            font-size: 0.875rem; /* text-sm */
            font-weight: 600; /* font-semibold */
            color: #d97706; /* amber-600 */
            margin-bottom: 0.5rem; /* mb-2 */
        }
        .detail-sale-timer-time {
            display: flex;
            justify-content: center;
            gap: 0.75rem; /* space-x-3 */
            flex-wrap: wrap; /* NEW: Allow wrapping on small screens */
        }
        .detail-sale-timer-block {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #ffffff;
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.5rem; /* MODIFIED: Reduced padding */
            min-width: 48px; /* MODIFIED: Reduced min-width */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            border: 1px solid #f3f4f6; /* border-gray-100 */
        }
        .detail-sale-timer-num {
            font-size: 1.25rem; /* MODIFIED: Reduced font size */
            font-weight: 700; /* font-bold */
            color: #d97706; /* amber-600 */
            line-height: 1.2;
        }
        .detail-sale-timer-label {
            font-size: 0.75rem; /* text-xs */
            font-weight: 500; /* font-medium */
            color: #6b7280; /* gray-500 */
        }
        /* --- END Sale Timer Styles --- */

        /* --- Checkout Form Styles --- */
        .form-input {
            appearance: none;
            background-color: #f9fafb; /* gray-50 / light gray */
            border: 1px solid #e5e7eb; /* gray-200 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.6rem 1rem;
            color: #1f2937; /* gray-800 */
            width: 100%;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        /* Focus state: black border (ring-black focus logic) */
        .form-input:focus {
            outline: none;
            border-color: #111827; /* gray-900 / black */
            box-shadow: 0 0 0 1px #111827; /* thin black ring */
            background-color: #ffffff;
        }

        /* --- Payment Method Styles --- */
        .payment-logo-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .payment-logo {
            width: 100px; /* fixed width for consistency */
            height: 50px; /* fixed height for consistency */
            padding: 0.25rem;
            border: 2px solid transparent;
            border-radius: 0.5rem;
            cursor: pointer;
            object-fit: contain; /* Ensure the logo fits inside the container */
            transition: border-color 0.2s, opacity 0.2s;
            opacity: 0.6;
        }
        .payment-logo:hover {
            opacity: 0.8;
        }
        .payment-logo.selected {
            border-color: #111827; /* Black border on selection */
            opacity: 1;
            box-shadow: 0 0 0 1px #111827;
        }

        /* NEW: Auth Modal Styles */
        .modal-card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 400px;
            width: 95%;
            padding: 1.5rem; /* p-6 */
        }
        .tab-button {
            padding: 0.5rem 1rem;
            font-weight: 600;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
            color: #6b7280; /* gray-500 */
        }
        .tab-button.active {
            border-color: #ea580c; /* orange-600 */
            color: #111827; /* gray-900 */
        }

        /* Sidebar Custom Styles (NEW) */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 80%; 
            max-width: 300px; 
            z-index: 60; 
            transform: translateX(-100%); 
            transition: transform 0.3s ease-in-out;
        }

        .sidebar.open {
            transform: translateX(0); 
        }

        .backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 55;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none; 
        }

        .backdrop.open {
            opacity: 1;
            pointer-events: auto; 
        }
    </style>
</head>
<body class="bg-white">

    <div id="sidebar-backdrop" class="backdrop hidden"></div>

    <div id="mobile-sidebar" class="sidebar bg-white shadow-xl p-4 dark:bg-gray-900">
        <div class="flex justify-end mb-6">
            <button id="sidebar-close-btn" class="text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">
                <i class="ph ph-x text-2xl"></i>
            </button>
        </div>
        
        <h3 class="text-xl font-bold text-gray-900 mb-4 border-b pb-2 dark:text-white dark:border-gray-700">Customer Menu</h3>
        
        <nav class="space-y-4">
            <a href="#" id="sidebar-track-order-link" class="flex items-center text-lg font-medium text-gray-700 hover:text-orange-600 dark:text-gray-300 dark:hover:text-orange-500">
                <i class="ph ph-package text-2xl mr-3"></i>
                Track Order
            </a>
            <a href="#" id="sidebar-wishlist-link" class="flex items-center text-lg font-medium text-gray-700 hover:text-orange-600 dark:text-gray-300 dark:hover:text-orange-500">
                <i class="ph ph-heart text-2xl mr-3"></i>
                WhishList
            </a>
            <button id="sidebar-theme-toggle-btn" title="Toggle theme" class="w-full flex items-center justify-start text-lg font-medium text-gray-700 hover:text-orange-600 p-0 dark:text-gray-300 dark:hover:text-orange-500">
                <i class="ph ph-circle-half text-2xl mr-3"></i>
                Dark / Light Mode Toggle
            </button>
        </nav>
        
    </div>
    <header class="border-b border-gray-200 bg-white sticky top-0 z-50 dark:bg-gray-900 dark:border-gray-800">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                
                <div class="flex items-center space-x-2">
                    <button id="mobile-menu-btn" class="text-gray-600 hover:text-orange-600 p-1">
                        <img 
                            src="https://res.cloudinary.com/dqr2ewypl/image/upload/v1762683166/menu-vector-icon-transparent-background-logo-design-concept-122599749_pksacm.webp" 
                            alt="Menu" 
                            class="h-6 w-6 object-contain"
                        >
                    </button>
                    <div class="flex-shrink-0">
                        <a href="#" id="logo-link" class="text-3xl font-bold text-orange-600">RareShop</a>
                    </div>
                </div>

                <div class="flex-1 max-w-2xl mx-4 hidden sm:block">
                    <form class="flex w-full">
                        <input
                            type="search"
                            class="flex-1 w-full px-4 py-2 text-gray-700 bg-gray-100 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent dark:bg-gray-800 dark:text-gray-300 dark:border-gray-700"
                            placeholder="Search in RareShop"
                        />
                        <button class="px-4 py-2 bg-orange-600 text-white rounded-r-md hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-orange-500">
                            <i class="ph ph-magnifying-glass text-xl"></i>
                        </button>
                    </form>
                </div>

                <div class="flex items-center space-x-4">
                    <a href="dash.html" id="admin-link" class="text-gray-600 hover:text-orange-600 text-sm font-medium hidden">Admin Dashboard</a>
                    
                    <a href="#" id="cart-link" class="relative text-gray-600 hover:text-orange-600 dark:text-gray-300 dark:hover:text-orange-500">
                        <i class="ph ph-shopping-cart text-3xl"></i>
                        <span id="cart-item-count" class="absolute top-0 right-0 -mt-1 -mr-1 px-1.5 py-0.5 bg-orange-600 text-white text-xs font-bold rounded-full">0</span>
                    </a>
                    
                    <div id="auth-status-container" class="flex items-center space-x-2">
                        <a href="#" id="login-link" class="text-gray-600 hover:text-orange-600 text-sm font-medium dark:text-gray-300 dark:hover:text-orange-500">Login</a>
                        <span class="text-gray-300">|</span>
                        <a href="#" id="signup-link" class="text-gray-600 hover:text-orange-600 text-sm font-medium dark:text-gray-300 dark:hover:text-orange-500">Sign Up</a>
                    </div>
                </div>
            </div>
            <div class="sm:hidden py-2">
                 <form class="flex w-full">
                    <input
                        type="search"
                        class="flex-1 w-full px-4 py-2 text-gray-700 bg-gray-100 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                        placeholder="Search in RareShop"
                    />
                    <button class="px-4 py-2 bg-orange-600 text-white rounded-r-md hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-orange-500">
                        <i class="ph ph-magnifying-glass text-xl"></i>
                    </button>
                </form>
            </div>
        </div>
    </header>

    <main id="main-content-container" class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        </main>

    <template id="home-view-template">
        <div>
            <section class="mb-12">
                <div id="image-carousel" class="carousel-container animate-fade-in">
                    <div class="carousel-track">
                        <div class="carousel-slide">
                             <div class="carousel-slide-placeholder flex items-center justify-center">
                                <i class="ph ph-spinner-gap text-4xl animate-spin text-gray-500"></i>
                             </div>
                        </div>
                    </div>
                    <div id="carousel-dots-container" class="carousel-dots">
                        </div>
                </div>
            </section>
            <section class="mb-12">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 animate-slide-up" style="animation-delay: 0.1s;">Featured Products</h2>
                <div id="featured-products-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 md:gap-6">
                    </div>
                <div id="featured-products-view-more" class="text-right mt-4 hidden">
                    <a href="#" data-tag="featured" class="view-more-link text-orange-600 hover:text-orange-700 font-medium flex items-center justify-end">
                        View More <i class="ph ph-arrow-right text-xl ml-1"></i>
                    </a>
                </div>
            </section>
            
            <section class="mb-12">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 animate-slide-up" style="animation-delay: 0.2s;">Categories</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <a href="#" data-category="Laptops" class="category-link group block bg-gray-100 rounded-lg p-6 text-center hover:bg-orange-100 hover:shadow-lg transition-all duration-300 h-full flex flex-col items-center">
                        <img 
                            src="https://res.cloudinary.com/dkesvcbnp/image/upload/v1762259197/aa-4012-2375740-270525122431924-78721-0-090725081526189_xm1lru.webp" 
                            alt="Laptops" 
                            class="h-24 w-full object-contain mb-4 rounded-md"
                            onerror="this.onerror=null;this.src='https://placehold.co/150x100/e2e8f0/9ca3af?text=Laptop';"
                        >
                        <h3 class="text-lg font-semibold text-gray-900 mt-auto">Laptops</h3>
                    </a>
                    <a href="#" data-category="Phones" class="category-link group block bg-gray-100 rounded-lg p-6 text-center hover:bg-orange-100 hover:shadow-lg transition-all duration-300 h-full flex flex-col items-center">
                        <img 
                            src="https://res.cloudinary.com/dkesvcbnp/image/upload/v1762267425/mobile-phones-500x500_xmbtrm.webp" 
                            alt="Phones" 
                            class="h-24 w-full object-contain mb-4 rounded-md"
                            onerror="this.onerror=null;this.src='https://placehold.co/150x100/e2e8f0/9ca3af?text=Phone';"
                        >
                        <h3 class="text-lg font-semibold text-gray-900 mt-auto">Phones</h3>
                    </a>
                    <a href="#" data-category="TV" class="category-link group block bg-gray-100 rounded-lg p-6 text-center hover:bg-orange-100 hover:shadow-lg transition-all duration-300 h-full flex flex-col items-center">
                        <img 
                            src="https://res.cloudinary.com/dkesvcbnp/image/upload/v1762267796/images_4_pfsuvq.jpg" 
                            alt="TV" 
                            class="h-24 w-full object-contain mb-4 rounded-md"
                            onerror="this.onerror=null;this.src='https://placehold.co/150x100/e2e8f0/9ca3af?text=TV';"
                        >
                        <h3 class="text-lg font-semibold text-gray-900 mt-auto">TV</h3>
                    </a>
                    <a href="#" data-category="Computers" class="category-link group block bg-gray-100 rounded-lg p-6 text-center hover:bg-orange-100 hover:shadow-lg transition-all duration-300 h-full flex flex-col items-center">
                        <img 
                            src="https://res.cloudinary.com/dkesvcbnp/image/upload/v1762267725/images_3_a1infn.jpg" 
                            alt="Computers" 
                            class="h-24 w-full object-contain mb-4 rounded-md"
                            onerror="this.onerror=null;this.src='https://placehold.co/150x100/e2e8f0/9ca3af?text=Computer';"
                        >
                        <h3 class="text-lg font-semibold text-gray-900 mt-auto">Computers</h3>
                    </a>
                </div>
            </section>

            <section class="mb-12">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 animate-slide-up" style="animation-delay: 0.3s;">Top Sales</h2>
                <div id="top-sales-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 md:gap-6">
                    </div>
                <div id="top-sales-view-more" class="text-right mt-4 hidden">
                    <a href="#" data-tag="top-sales" class="view-more-link text-orange-600 hover:text-orange-700 font-medium flex items-center justify-end">
                        View More <i class="ph ph-arrow-right text-xl ml-1"></i>
                    </a>
                </div>
            </section>

            <section class="mb-12">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 animate-slide-up" style="animation-delay: 0.4s;">Most Popular</h2>
                <div id="most-popular-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 md:gap-6">
                    </div>
                <div id="most-popular-view-more" class="text-right mt-4 hidden">
                    <a href="#" data-tag="most-popular" class="view-more-link text-orange-600 hover:text-orange-700 font-medium flex items-center justify-end">
                        View More <i class="ph ph-arrow-right text-xl ml-1"></i>
                    </a>
                </div>
            </section>
        </div>
    </template>

    <template id="listing-view-template">
        <div>
            <button id="back-to-home-btn-listing" class="mb-8 flex items-center text-gray-600 hover:text-orange-600 font-medium transition-colors">
                <i class="ph ph-arrow-left text-xl mr-2"></i> Back to Home
            </button>
            
            <h1 id="listing-page-title" class="text-3xl font-bold text-gray-800 mb-8 border-b pb-4">Product Listing</h1>
            
            <div id="listing-products-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-6">
                </div>
        </div>
    </template>

    <template id="category-listing-template">
        <div>
             <button id="back-to-home-btn-category" class="mb-8 flex items-center text-gray-600 hover:text-orange-600 font-medium transition-colors">
                <i class="ph ph-arrow-left text-xl mr-2"></i> Back to Home
            </button>
            
            <h1 id="category-page-title" class="text-3xl font-bold text-gray-800 mb-8 border-b pb-4">Category</h1>

            <div id="category-products-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-6">
                </div>
            
            <div id="pagination-controls" class="flex items-center justify-between mt-10 border-t pt-6">
                <button id="prev-page-btn" class="flex items-center px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="ph ph-arrow-left text-lg mr-2"></i> Previous
                </button>
                <span id="page-info" class="text-sm font-medium text-gray-600">Page 1 of 1</span>
                <button id="next-page-btn" class="flex items-center px-4 py-2 bg-orange-600 text-white rounded-lg font-medium hover:bg-orange-700 transition-colors shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                    Next <i class="ph ph-arrow-right text-lg ml-2"></i>
                </button>
            </div>
        </div>
    </template>

    <template id="detail-view-template">
        <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-10">
            <button id="back-to-list-btn-detail" class="mb-6 flex items-center text-orange-600 hover:text-orange-800 font-medium transition-colors">
                <i class="ph ph-arrow-left text-xl mr-2"></i> Back
            </button>

            <div id="detail-content-wrapper" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                </div>
        </div>
    </template>
    
    <template id="cart-view-template">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-3xl font-bold text-gray-800 mb-8 border-b pb-4">Your Shopping Cart</h1>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 space-y-4" id="cart-items-container">
                    <p class="text-gray-500 text-center p-8 border rounded-lg" id="cart-empty-message">Your cart is empty.</p>
                </div>
                
                <div class="lg:col-span-1 bg-gray-50 p-6 rounded-xl shadow-md border border-gray-200 h-fit sticky top-24">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Cart Summary</h2>
                    <div class="space-y-3 text-gray-700">
                        <div class="flex justify-between">
                            <span>Subtotal (<span id="summary-item-count">0</span> items)</span>
                            <span id="summary-subtotal" class="font-medium">Rs.0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Shipping</span>
                            <span class="font-medium text-green-600">FREE</span>
                        </div>
                        <div class="flex justify-between border-t pt-3 border-gray-300 text-lg font-bold text-gray-900">
                            <span>Total</span>
                            <span id="summary-total">Rs.0.00</span>
                        </div>
                    </div>
                    
                    <button id="proceed-to-checkout-btn" class="w-full mt-6 py-3 bg-orange-600 text-white text-lg font-semibold rounded-lg shadow-md hover:bg-orange-700 transition-colors disabled:opacity-50" disabled>
                        Proceed to Checkout
                    </button>
                </div>
            </div>
        </div>
    </template>
    <template id="checkout-view-template">
        <div class="max-w-6xl mx-auto">
            <a href="#" id="return-to-cart-link" class="mb-4 inline-flex items-center text-gray-600 hover:text-orange-600 font-medium transition-colors">
                <i class="ph ph-arrow-left text-xl mr-2"></i> Return to cart
            </a>
            
            <h1 class="text-3xl font-bold text-gray-900 mb-8 border-b pb-4">Checkout</h1>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <form id="checkout-form" class="space-y-6">
                        
                        <div>
                            <h2 class="text-xl font-semibold text-gray-800 mb-4">Contact Information</h2>
                            <input type="email" id="contact-email" placeholder="Email" class="form-input" required>
                        </div>

                        <div>
                            <h2 class="text-xl font-semibold text-gray-800 mb-4">Shipping Address</h2>
                            
                            <div class="mb-4">
                                <input type="text" id="shipping-country" value="Pakistan" class="form-input bg-gray-200 cursor-not-allowed" readonly>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <input type="text" id="shipping-first-name" placeholder="First name" class="form-input" required>
                                <input type="text" id="shipping-last-name" placeholder="Last name" class="form-input" required>
                            </div>
                            
                            <div class="mb-4">
                                <input type="text" id="shipping-address" placeholder="Address" class="form-input" required>
                            </div>

                            <div class="mb-4">
                                <input type="text" id="shipping-apartment" placeholder="Apartment, suite, etc. (optional)" class="form-input">
                            </div>

                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <input type="text" id="shipping-city" placeholder="City" class="form-input" required>
                                <input type="text" id="shipping-postal-code" placeholder="Postal code" class="form-input" required>
                            </div>
                            
                            <div>
                                <input type="tel" id="shipping-phone" placeholder="Phone" class="form-input" required>
                            </div>
                        </div>

                        <!-- ðŸ“¢ MANUAL PAYMENT METHOD SELECTION -->
                        <div>
                            <h2 class="text-xl font-semibold text-gray-800 mb-4">Choose Advance Payment Method</h2>
                            
                            <div class="payment-logo-container mb-6">
                                <img src="https://res.cloudinary.com/dqr2ewypl/image/upload/v1762354282/acded9d6362d497965c18a071cb9fd_yojbkb.webp" 
                                     alt="Easypaisa" 
                                     class="payment-logo" 
                                     data-method="easypaisa"
                                     data-heading="Easypaisa"
                                     data-instructions="1: Send payment to 03141550827\n2: Account name Farhana Imam"
                                >
                                <img src="https://res.cloudinary.com/dqr2ewypl/image/upload/v1762354552/2068807-nayapay-1569836083_n4dt2g.jpg" 
                                     alt="NayaPay" 
                                     class="payment-logo" 
                                     data-method="nayapay"
                                     data-heading="NayaPay"
                                     data-instructions="1: Send payment to 03409796147\n2: Account name Nisar Ud Din"
                                >
                                <img src="https://res.cloudinary.com/dqr2ewypl/image/upload/v1762354668/unnamed_e9pkpn.webp" 
                                     alt="Digitt+" 
                                     class="payment-logo" 
                                     data-method="digittplus"
                                     data-heading="Digitt+"
                                     data-instructions="1: Send payment to 03349284416\n2: Account name Shukriya BIBI"
                                >
                            </div>

                            <div id="payment-instructions-container" class="bg-gray-100 p-4 rounded-lg border border-gray-200 hidden mb-6">
                                <h3 id="payment-instructions-heading" class="text-xl font-bold text-gray-900 mb-3"></h3>
                                <pre id="payment-instructions-text" class="whitespace-pre-wrap text-gray-700"></pre>
                            </div>
                        </div>
                        
                        <!-- ðŸ“¢ SUPABASE PAYMENT PROOF UPLOAD SECTION -->
                        <div id="payment-proof-section">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4 pt-4 border-t">Payment Proof Upload (Required)</h2>
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 space-y-3">
                                <label for="payment-screenshot-file" class="block text-sm font-medium text-gray-700">
                                    Upload Payment Screenshot (JPG/PNG)
                                </label>
                                <input type="file" id="payment-screenshot-file" required accept="image/png, image/jpeg" class="w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200">
                                <p id="upload-status" class="text-sm text-blue-700 hidden">Ready to upload...</p>
                            </div>
                        </div>
                        <!-- END PAYMENT PROOF UPLOAD SECTION -->

                        <div id="whatsapp-instructions-section" class="space-y-4 pt-4 border-t">
                            <h2 class="text-xl font-semibold text-gray-800">Verification Steps</h2>
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <h3 class="text-lg font-medium text-green-800">Final Action Recommended:</h3>
                                <p class="text-green-700 mt-2">
                                    Your order will be verified using the uploaded proof. For faster processing, please send your order ID to our WhatsApp number after placing the order.
                                </p>
                                <a href="https://wa.me/923430821414" target="_blank" class="mt-3 inline-flex items-center justify-center px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors">
                                    <i class="ph ph-whatsapp-logo text-xl mr-2"></i>
                                    Send Order ID to WhatsApp (03430821414)
                                </a>
                            </div>
                        </div>
                        <button type="submit" id="checkout-buy-now-btn" class="w-full py-4 bg-gray-900 text-white text-xl font-bold rounded-lg shadow-xl hover:bg-black transition-colors disabled:opacity-50 mt-6">
                            Place Order (Rs.0.00)
                        </button>
                        
                    </form>
                </div>

                <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border border-gray-200 h-fit sticky top-24">
                    <h2 class="text-xl font-bold text-gray-900 mb-4 border-b pb-2">Order Summary</h2>
                    <div id="checkout-summary-content">
                        <p class="text-center text-gray-500 py-6"><i class="ph ph-spinner-gap animate-spin mr-2"></i> Loading summary...</p>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="track-order-list-template">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-3xl font-bold text-gray-900 mb-8 border-b pb-4 dark:text-white">Your Orders</h1>
            
            <div id="orders-list-container" class="space-y-4">
                <p class="text-gray-500 text-center p-8 border rounded-lg dark:text-gray-400 dark:border-gray-700">
                    <i class="ph ph-spinner-gap text-2xl animate-spin mr-2"></i> Loading your orders...
                </p>
            </div>
            
            <p id="no-orders-message" class="text-gray-500 text-center p-8 border rounded-lg hidden dark:text-gray-400 dark:border-gray-700">
                You have not placed any orders yet.
            </p>
        </div>
    </template>

    <template id="order-detail-template">
        <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8 dark:bg-gray-800 dark:shadow-2xl">
            <button id="back-to-list-btn" class="mb-6 flex items-center text-orange-600 hover:text-orange-800 font-medium transition-colors">
                <i class="ph ph-arrow-left text-xl mr-2"></i> Back to Orders
            </button>

            <h1 class="text-3xl font-bold text-gray-900 mb-4 border-b pb-2 dark:text-white">Order <span id="detail-order-id-short"></span></h1>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="space-y-2 p-4 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100">Contact & Shipping</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-300">
                        <span id="detail-customer-name" class="font-medium"></span><br>
                        <span id="detail-customer-address"></span><br>
                        <span id="detail-customer-phone"></span>
                    </p>
                </div>
                <div class="space-y-2 p-4 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100">Details</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-300">
                        **Order Date:** <span id="detail-order-date"></span><br>
                        **Payment:** <span id="detail-payment-method"></span><br>
                        **Status:** <span id="detail-status" class="font-bold text-green-600">Payment Confirmed</span>
                    </p>
                </div>
            </div>

            <h3 class="text-xl font-bold text-gray-900 mb-4 border-b pb-2 dark:text-white">Items Ordered</h3>
            <div id="detail-items-container" class="space-y-3">
                </div>

            <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200 dark:border-gray-600">
                <span class="text-xl font-bold text-gray-900 dark:text-white">Order Total</span>
                <span id="detail-total-price" class="text-xl font-bold text-orange-600">Rs.0.00</span>
            </div>
        </div>
    </template>
    
    <template id="faq-view-template">
        <div class="max-w-4xl mx-auto">
            <button id="back-to-home-btn-faq" class="mb-8 flex items-center text-gray-600 hover:text-orange-600 font-medium transition-colors">
                <i class="ph ph-arrow-left text-xl mr-2"></i> Back to Home
            </button>
            
            <h1 class="text-3xl font-bold text-gray-800 mb-8 border-b pb-4">Frequently Asked Questions</h1>
            
            <div id="faq-accordion-container" class="space-y-4">
                
                <div class="faq-item border border-gray-200 rounded-lg shadow-sm overflow-hidden">
                    <button class="faq-question w-full flex items-center justify-between text-left p-4 md:p-5 bg-white hover:bg-gray-50 transition-colors">
                        <span class="text-base md:text-lg font-medium text-gray-800">1. How can I place an order on your website?</span>
                        <i class="ph ph-plus text-xl text-orange-600 flex-shrink-0"></i>
                        <i class="ph ph-minus text-xl text-orange-600 flex-shrink-0 hidden"></i>
                    </button>
                    <div class="faq-answer hidden p-4 md:p-5 border-t border-gray-100 bg-white">
                        <p class="text-gray-700">Simply browse our products, add your desired items to the cart, proceed to checkout, and complete the advance payment using one of the provided methods. Your order will be processed after payment proof is verified.</p>
                    </div>
                </div>

                <div class="faq-item border border-gray-200 rounded-lg shadow-sm overflow-hidden">
                    <button class="faq-question w-full flex items-center justify-between text-left p-4 md:p-5 bg-white hover:bg-gray-50 transition-colors">
                        <span class="text-base md:text-lg font-medium text-gray-800">2. Do you offer Cash on Delivery (COD)?</span>
                        <i class="ph ph-plus text-xl text-orange-600 flex-shrink-0"></i>
                        <i class="ph ph-minus text-xl text-orange-600 flex-shrink-0 hidden"></i>
                    </button>
                    <div class="faq-answer hidden p-4 md:p-5 border-t border-gray-100 bg-white">
                        <p class="text-gray-700">Currently, we only accept advance payments (via bank transfer, Easypaisa, NayaPay, or Digitt+). Once payment proof is uploaded and verified, your order will be confirmed and shipped.</p>
                    </div>
                </div>

                <div class="faq-item border border-gray-200 rounded-lg shadow-sm overflow-hidden">
                    <button class="faq-question w-full flex items-center justify-between text-left p-4 md:p-5 bg-white hover:bg-gray-50 transition-colors">
                        <span class="text-base md:text-lg font-medium text-gray-800">3. How long does delivery take?</span>
                        <i class="ph ph-plus text-xl text-orange-600 flex-shrink-0"></i>
                        <i class="ph ph-minus text-xl text-orange-600 flex-shrink-0 hidden"></i>
                    </button>
                    <div class="faq-answer hidden p-4 md:p-5 border-t border-gray-100 bg-white">
                        <p class="text-gray-700">Delivery usually takes 2 to 5 working days for major cities and 5 to 7 days for remote areas across Pakistan.</p>
                    </div>
                </div>

                <div class="faq-item border border-gray-200 rounded-lg shadow-sm overflow-hidden">
                    <button class="faq-question w-full flex items-center justify-between text-left p-4 md:p-5 bg-white hover:bg-gray-50 transition-colors">
                        <span class="text-base md:text-lg font-medium text-gray-800">4. How will I know if my order is confirmed?</span>
                        <i class="ph ph-plus text-xl text-orange-600 flex-shrink-0"></i>
                        <i class="ph ph-minus text-xl text-orange-600 flex-shrink-0 hidden"></i>
                    </button>
                    <div class="faq-answer hidden p-4 md:p-5 border-t border-gray-100 bg-white">
                        <p class="text-gray-700">After successful payment verification, youâ€™ll receive an order confirmation message or email with your tracking details once the product is shipped.</p>
                    </div>
                </div>

                <div class="faq-item border border-gray-200 rounded-lg shadow-sm overflow-hidden">
                    <button class="faq-question w-full flex items-center justify-between text-left p-4 md:p-5 bg-white hover:bg-gray-50 transition-colors">
                        <span class="text-base md:text-lg font-medium text-gray-800">5. What if my product arrives with a scratch or defect?</span>
                        <i class="ph ph-plus text-xl text-orange-600 flex-shrink-0"></i>
                        <i class="ph ph-minus text-xl text-orange-600 flex-shrink-0 hidden"></i>
                    </button>
                    <div class="faq-answer hidden p-4 md:p-5 border-t border-gray-100 bg-white">
                        <p class="text-gray-700">If your product arrives damaged or scratched, please contact us immediately with unboxing pictures/videos. Weâ€™ll arrange a return or replacement as per our policy.</p>
                    </div>
                </div>

                <div class="faq-item border border-gray-200 rounded-lg shadow-sm overflow-hidden">
                    <button class="faq-question w-full flex items-center justify-between text-left p-4 md:p-5 bg-white hover:bg-gray-50 transition-colors">
                        <span class="text-base md:text-lg font-medium text-gray-800">6. Do you offer a return or refund policy?</span>
                        <i class="ph ph-plus text-xl text-orange-600 flex-shrink-0"></i>
                        <i class="ph ph-minus text-xl text-orange-600 flex-shrink-0 hidden"></i>
                    </button>
                    <div class="faq-answer hidden p-4 md:p-5 border-t border-gray-100 bg-white">
                        <p class="text-gray-700">Yes! You can return a product within 30 days if it has any manufacturing fault or shipping damage. The item must be unused and in its original packaging.</p>
                    </div>
                </div>

                <div class="faq-item border border-gray-200 rounded-lg shadow-sm overflow-hidden">
                    <button class="faq-question w-full flex items-center justify-between text-left p-4 md:p-5 bg-white hover:bg-gray-50 transition-colors">
                        <span class="text-base md:text-lg font-medium text-gray-800">7. Are your products original and brand new?</span>
                        <i class="ph ph-plus text-xl text-orange-600 flex-shrink-0"></i>
                        <i class="ph ph-minus text-xl text-orange-600 flex-shrink-0 hidden"></i>
                    </button>
                    <div class="faq-answer hidden p-4 md:p-5 border-t border-gray-100 bg-white">
                        <p class="text-gray-700">Absolutely. All our phones, laptops, TVs, and computers are 100% original, brand new, and come with official warranty (where applicable).</p>
                    </div>
                </div>

                <div class="faq-item border border-gray-200 rounded-lg shadow-sm overflow-hidden">
                    <button class="faq-question w-full flex items-center justify-between text-left p-4 md:p-5 bg-white hover:bg-gray-50 transition-colors">
                        <span class="text-base md:text-lg font-medium text-gray-800">8. Do you ship all over Pakistan?</span>
                        <i class="ph ph-plus text-xl text-orange-600 flex-shrink-0"></i>
                        <i class="ph ph-minus text-xl text-orange-600 flex-shrink-0 hidden"></i>
                    </button>
                    <div class="faq-answer hidden p-4 md:p-5 border-t border-gray-100 bg-white">
                        <p class="text-gray-700">Yes, we deliver nationwide through reliable courier partners like TCS, Leopards, and M&P.</p>
                    </div>
                </div>

            </div>
        </div>
    </template>
    <template id="shipping-policy-view-template">
        <div class="max-w-4xl mx-auto">
            <button id="back-to-home-btn-shipping" class="mb-8 flex items-center text-gray-600 hover:text-orange-600 font-medium transition-colors">
                <i class="ph ph-arrow-left text-xl mr-2"></i> Back to Home
            </button>
            
            <h1 class="text-3xl font-bold text-gray-800 mb-8 border-b pb-4">RareShop Shipping Policy</h1>
            
            <div class="space-y-6 bg-white p-6 md:p-8 rounded-lg shadow-sm border border-gray-200 text-gray-700">
                <p>At RareShop, we aim to deliver your products safely and on time across Pakistan. Please read our shipping policy carefully to understand how we process, handle, and deliver your orders.</p>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">1. Order Processing</h2>
                    <ul class="list-disc list-inside space-y-1 pl-2">
                        <li>All orders are processed after full advance payment and proof verification.</li>
                        <li>Once payment is verified, your order will be packed and dispatched within 24â€“48 hours (excluding Sundays and public holidays).</li>
                        <li>You will receive an order confirmation message or email with your order details and tracking information.</li>
                    </ul>
                </div>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">2. Shipping & Delivery Time</h2>
                    <ul class="list-disc list-inside space-y-1 pl-2">
                        <li>Delivery across major cities (Karachi, Lahore, Islamabad, Faisalabad, Rawalpindi, etc.) takes approximately 2â€“5 working days.</li>
                        <li>For remote or rural areas, delivery may take 5â€“7 working days.</li>
                        <li>All shipments are sent via trusted courier services like TCS, Leopards, and M&P.</li>
                    </ul>
                </div>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">3. Payment Method</h2>
                    <ul class="list-disc list-inside space-y-1 pl-2">
                        <li>Currently, RareShop operates on a prepayment basis only.</li>
                        <li>Customers can pay through:
                            <ul class="list-disc list-inside ml-6 mt-1">
                                <li>Bank Transfer</li>
                                <li>Easypaisa</li>
                                <li>NayaPay / Digitt+ (Other Local Wallets)</li>
                            </ul>
                        </li>
                        <li>Orders are processed only after payment proof is uploaded and verified.</li>
                    </ul>
                </div>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">4. Shipping Charges</h2>
                    <ul class="list-disc list-inside space-y-1 pl-2">
                        <li>Shipping charges vary based on product weight, size, and destination.</li>
                        <li>The exact delivery fee will be displayed at checkout before completing the order.</li>
                        <li>Occasionally, free shipping offers are available on selected products or promotions.</li>
                    </ul>
                </div>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">5. Order Tracking</h2>
                    <ul class="list-disc list-inside space-y-1 pl-2">
                        <li>Once your order is shipped, you will receive a tracking number via email or SMS.</li>
                        <li>You can track your order directly on the courierâ€™s official website using the tracking ID provided.</li>
                    </ul>
                </div>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">6. Damaged or Scratched Products</h2>
                    <ul class="list-disc list-inside space-y-1 pl-2">
                        <li>Customers must record an unboxing video when opening their package.</li>
                        <li>If a product is received scratched, damaged, or defective, contact us within 24 hours of delivery.</li>
                        <li>We will review your claim and arrange a return, replacement, or refund in accordance with our 30-day return policy.</li>
                    </ul>
                </div>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">7. Delays & Exceptions</h2>
                    <ul class="list-disc list-inside space-y-1 pl-2">
                        <li>Delivery delays may occur due to weather, strikes, courier issues, or public holidays.</li>
                        <li>RareShop is not responsible for delays caused by factors outside our control, but we will always help you track and resolve issues.</li>
                    </ul>
                </div>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">8. Contact Us</h2>
                    <p>For any shipping-related inquiries, please contact our support team:</p>
                    <ul class="list-none space-y-1 mt-2">
                        <li class="flex items-center">
                            <i class="ph ph-envelope text-xl mr-2 text-orange-600"></i>
                            <a href="mailto:businessrareshop1@gmail.com" class="hover:text-orange-600 transition-colors">businessrareshop1@gmail.com</a>
                        </li>
                        <li class="flex items-center">
                            <i class="ph ph-whatsapp-logo text-xl mr-2 text-orange-600"></i>
                            <a href="https://wa.me/923430821414" class="hover:text-orange-600 transition-colors">+92 3430821414</a>
                        </li>
                        <li class="flex items-center">
                            <i class="ph ph-clock text-xl mr-2 text-orange-600"></i>
                            <span>Support Hours: Mondayâ€“Saturday, 10:00 AM â€“ 8:00 PM</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </template>
    <template id="return-policy-view-template">
        <div class="max-w-4xl mx-auto">
            <button id="back-to-home-btn-return" class="mb-8 flex items-center text-gray-600 hover:text-orange-600 font-medium transition-colors">
                <i class="ph ph-arrow-left text-xl mr-2"></i> Back to Home
            </button>
            
            <h1 class="text-3xl font-bold text-gray-800 mb-8 border-b pb-4">RareShop Return & Refund Policy</h1>
            
            <div class="space-y-6 bg-white p-6 md:p-8 rounded-lg shadow-sm border border-gray-200 text-gray-700">
                <p>At RareShop, customer satisfaction is our top priority. We ensure all our products are genuine, brand new, and carefully inspected before shipping. However, if you receive a faulty or damaged item, our return policy ensures a fair and smooth process.</p>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">1. Return Eligibility</h2>
                    <p class="mb-2">You can request a return, replacement, or refund if:</p>
                    <ul class="list-disc list-inside space-y-1 pl-2">
                        <li>The product is damaged, scratched, or defective upon delivery.</li>
                        <li>You receive the wrong product or wrong model.</li>
                        <li>The item has a manufacturing fault within 30 days of delivery.</li>
                    </ul>
                    <p class="mt-3 font-medium text-gray-800">âš ï¸ Note: Returns are not accepted for:</p>
                    <ul class="list-disc list-inside space-y-1 pl-2 text-sm">
                        <li>Change of mind or dislike of product.</li>
                        <li>Damage caused after delivery (e.g., drops, misuse, or liquid damage).</li>
                        <li>Items without the original packaging, accessories, or invoice.</li>
                    </ul>
                </div>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">2. Return Timeframe</h2>
                    <ul class="list-disc list-inside space-y-1 pl-2">
                        <li>You must file a return request within 30 days from the date of delivery.</li>
                        <li>Requests made after 30 days will not be accepted.</li>
                    </ul>
                </div>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">3. Return Process</h2>
                    <p class="mb-2 font-medium text-gray-800">Contact Us:</p>
                    <ul class="list-disc list-inside space-y-1 pl-2 mb-4">
                        <li>Reach out to our support team via WhatsApp or email within 30 days of receiving your product.</li>
                    </ul>
                    <p class="mb-2 font-medium text-gray-800">Provide Proof:</p>
                    <ul class="list-disc list-inside space-y-1 pl-2 mb-4">
                        <li>Share clear photos and/or an unboxing video showing the damage, scratch, or issue.</li>
                    </ul>
                    <p class="mb-2 font-medium text-gray-800">Verification:</p>
                    <ul class="list-disc list-inside space-y-1 pl-2 mb-4">
                        <li>Our team will review your claim within 2â€“3 working days.</li>
                    </ul>
                    <p class="mb-2 font-medium text-gray-800">Approval & Return:</p>
                    <ul class="list-disc list-inside space-y-1 pl-2 mb-4">
                        <li>If approved, weâ€™ll share the return address and courier instructions.</li>
                        <li>The item must be securely packed in its original box with all accessories.</li>
                    </ul>
                    <p class="mb-2 font-medium text-gray-800">Replacement or Refund:</p>
                    <ul class="list-disc list-inside space-y-1 pl-2">
                        <li>Replacement will be sent after the returned item is inspected.</li>
                        <li>Refunds (if applicable) will be processed back to your original payment method within 5â€“7 working days after verification.</li>
                    </ul>
                </div>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">4. Shipping Costs for Returns</h2>
                    <ul class="list-disc list-inside space-y-1 pl-2">
                        <li>If the product is faulty, damaged, or incorrect, RareShop will cover all return shipping costs.</li>
                        <li>If the return is due to customer error (wrong model ordered, change of mind, etc.), the customer will bear the shipping charges.</li>
                    </ul>
                </div>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">5. Condition of Returned Products</h2>
                    <p class="mb-2">To qualify for a refund or replacement:</p>
                    <ul class="list-disc list-inside space-y-1 pl-2">
                        <li>The product must be unused, undamaged, and in its original packaging.</li>
                        <li>All included accessories, manuals, and warranty cards must be returned.</li>
                        <li>Items that show signs of use or tampering will not be accepted.</li>
                    </ul>
                </div>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">6. Non-Returnable Items</h2>
                    <p class="mb-2">For safety and warranty reasons, the following products cannot be returned once opened:</p>
                    <ul class="list-disc list-inside space-y-1 pl-2">
                        <li>Software or activation-locked devices.</li>
                        <li>Products with missing serial numbers or tampered warranty seals.</li>
                        <li>Accessories like chargers, cables, or earphones (unless defective on arrival).</li>
                    </ul>
                </div>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">7. Contact Us</h2>
                    <p>If you have any questions about our Return & Refund Policy, feel free to contact us:</p>
                    <ul class="list-none space-y-1 mt-2">
                        <li class="flex items-center">
                            <i class="ph ph-envelope text-xl mr-2 text-orange-600"></i>
                            <a href="mailto:businessrareshop1@gmail.com" class="hover:text-orange-600 transition-colors">businessrareshop1@gmail.com</a>
                        </li>
                        <li class="flex items-center">
                            <i class="ph ph-whatsapp-logo text-xl mr-2 text-orange-600"></i>
                            <a href="https://wa.me/923430821414" class="hover:text-orange-600 transition-colors">+92 3430821414</a>
                        </li>
                        <li class="flex items-center">
                            <i class="ph ph-clock text-xl mr-2 text-orange-600"></i>
                            <span>Support Hours: Mondayâ€“Saturday, 10:00 AM â€“ 8:00 PM</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </template>
    <template id="tos-view-template">
        <div class="max-w-4xl mx-auto">
            <button id="back-to-home-btn-tos" class="mb-8 flex items-center text-gray-600 hover:text-orange-600 font-medium transition-colors">
                <i class="ph ph-arrow-left text-xl mr-2"></i> Back to Home
            </button>
            
            <h1 class="text-3xl font-bold text-gray-800 mb-8 border-b pb-4">RareShop â€“ Terms of Service</h1>
            
            <div class="space-y-6 bg-white p-6 md:p-8 rounded-lg shadow-sm border border-gray-200 text-gray-700">
                <p>Welcome to RareShop. These Terms of Service (â€œTermsâ€, â€œAgreementâ€) govern your use of our website [www.https://rareservices.store/] and all related services, including product purchases, payments, and support.</p>
                <p>By accessing or purchasing from RareShop, you agree to these terms. Please read them carefully.</p>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">1. General Overview</h2>
                    <p class="mb-2">RareShop is an online store operating in Pakistan, offering a variety of electronics including phones, TVs, laptops, and computers.</p>
                    <p class="mb-2">By using our website, you confirm that:</p>
                    <ul class="list-disc list-inside space-y-1 pl-2">
                        <li>You are at least 18 years old, or using the website under supervision of a parent/guardian.</li>
                        <li>All information you provide during checkout (name, address, payment details) is accurate and complete.</li>
                    </ul>
                </div>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">2. Product Information</h2>
                    <ul class="list-disc list-inside space-y-1 pl-2">
                        <li>We make every effort to display accurate product details, images, and descriptions.</li>
                        <li>However, colors and specifications may vary slightly due to lighting or manufacturer changes.</li>
                        <li>All products are 100% original and brand new, unless clearly stated otherwise.</li>
                    </ul>
                </div>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">3. Pricing & Payment</h2>
                    <ul class="list-disc list-inside space-y-1 pl-2">
                        <li>All prices are listed in Pakistani Rupees (PKR) and include applicable taxes (if any).</li>
                        <li>Payment must be made in full before order confirmation.</li>
                        <li>We currently accept advance payments only (Easypaisa, NayaPay, Digi++).</li>
                        <li>Orders are processed only after payment proof is uploaded and verified.</li>
                        <li>RareShop reserves the right to cancel orders or change prices due to typographical or system errors.</li>
                    </ul>
                </div>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">4. Order Confirmation & Shipping</h2>
                    <ul class="list-disc list-inside space-y-1 pl-2">
                        <li>You will receive a confirmation message or email once your payment is verified.</li>
                        <li>Delivery time is 2â€“5 working days in major cities and 5â€“7 working days for other areas.</li>
                        <li>Orders are shipped via trusted courier partners (TCS, M&P, Leopards, etc.).</li>
                        <li>RareShop is not responsible for courier delays, customs issues, or incorrect delivery addresses provided by customers.</li>
                    </ul>
                </div>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">5. Return & Refund Policy</h2>
                    <ul class="list-disc list-inside space-y-1 pl-2">
                        <li>If your product arrives damaged, scratched, or defective, you can request a return within 30 days of delivery.</li>
                        <li>Returns are accepted only with proof (unboxing video or photos) and if the product is in its original packaging.</li>
                        <li>Refunds are processed to your original payment method within 5â€“7 working days after verification.</li>
                        <li>For complete details, please refer to our Return Policy.</li>
                    </ul>
                </div>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">6. Warranty</h2>
                    <ul class="list-disc list-inside space-y-1 pl-2">
                        <li>Products sold by RareShop come with manufacturer or shop warranty, depending on the product.</li>
                        <li>Warranty terms, duration, and coverage vary by brand and category.</li>
                        <li>Warranty does not cover physical damage, liquid damage, or unauthorized repairs.</li>
                    </ul>
                </div>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">7. User Responsibilities</h2>
                    <p class="mb-2">By using our website, you agree to:</p>
                    <ul class="list-disc list-inside space-y-1 pl-2">
                        <li>Not use RareShop for any illegal or fraudulent purpose.</li>
                        <li>Not attempt to hack, modify, or disrupt the websiteâ€™s functionality.</li>
                        <li>Provide accurate personal and payment information.</li>
                        <li>Comply with all applicable laws of Pakistan when making purchases.</li>
                    </ul>
                </div>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">8. Intellectual Property</h2>
                    <p class="mb-2">All website content â€” including logos, product images, designs, and text â€” is the exclusive property of RareShop.</p>
                    <p>Reproduction, copying, or use without written permission is strictly prohibited.</p>
                </div>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">9. Limitation of Liability</h2>
                    <ul class="list-disc list-inside space-y-1 pl-2">
                        <li>RareShop is not liable for indirect damages, loss of data, profit, or other consequential damages resulting from the use or inability to use our website or products.</li>
                        <li>Our liability, if any, shall not exceed the total amount paid by the customer for the product.</li>
                    </ul>
                </div>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">10. Changes to These Terms</h2>
                    <p class="mb-2">RareShop reserves the right to update or modify these Terms of Service at any time.</p>
                    <p>Any changes will be posted on this page with an updated â€œLast Updatedâ€ date.</p>
                </div>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">11. Governing Law</h2>
                    <p class="mb-2">These Terms are governed by the laws of Pakistan.</p>
                    <p>Any disputes shall be handled under the jurisdiction of courts located in Karachi, Pakistan.</p>
                </div>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">12. Contact Us</h2>
                    <p>If you have any questions about these Terms, please contact:</p>
                    <ul class="list-none space-y-1 mt-2">
                        <li class="flex items-center">
                            <i class="ph ph-envelope text-xl mr-2 text-orange-600"></i>
                            <a href="mailto:businessrareshop1@gmail.com" class="hover:text-orange-600 transition-colors">businessrareshop1@gmail.com</a>
                        </li>
                        <li class="flex items-center">
                            <i class="ph ph-whatsapp-logo text-xl mr-2 text-orange-600"></i>
                            <a href="https://wa.me/923430821414" class="hover:text-orange-600 transition-colors">+92 3430821414</a>
                        </li>
                        <li class="flex items-center">
                            <i class="ph ph-clock text-xl mr-2 text-orange-600"></i>
                            <span>Support Hours: Mondayâ€“Saturday, 10:00 AM â€“ 8:00 PM</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </template>
    <template id="about-view-template">
        <div class="max-w-4xl mx-auto">
            <button id="back-to-home-btn-about" class="mb-8 flex items-center text-gray-600 hover:text-orange-600 font-medium transition-colors">
                <i class="ph ph-arrow-left text-xl mr-2"></i> Back to Home
            </button>
            
            <h1 class="text-3xl font-bold text-gray-800 mb-8 border-b pb-4">About RareShop</h1>
            
            <div class="space-y-6 bg-white p-6 md:p-8 rounded-lg shadow-sm border border-gray-200 text-gray-700">
                <p class="text-lg">Welcome to RareShop, your trusted online destination for original phones, laptops, computers, and smart TVs in Pakistan.</p>
                <p>We are dedicated to providing top-quality electronics at competitive prices, with fast nationwide delivery and a smooth, secure shopping experience.</p>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">Who We Are</h2>
                    <p>RareShop is a Pakistan-based online electronics store offering genuine and brand-new tech products from the worldâ€™s leading brands.</p>
                    <p class="mt-2">Whether you are upgrading your smartphone, looking for a high-performance laptop, or enhancing your home entertainment setup, RareShop ensures authenticity and reliability in every purchase.</p>
                </div>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">Our Mission</h2>
                    <p class="mb-2">Our mission is to make modern technology accessible, affordable, and dependable for customers across Pakistan.</p>
                    <p class="mb-2">We focus on providing:</p>
                    <ul class="list-disc list-inside space-y-1 pl-2">
                        <li>Competitive and transparent pricing</li>
                        <li>Fast, reliable, and secure nationwide shipping</li>
                        <li>Simple 30-day return and replacement policy for damaged or faulty products</li>
                    </ul>
                </div>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">What We Offer</h2>
                    <ul class="list-disc list-inside space-y-1 pl-2">
                        <li>Latest Smartphones and Accessories</li>
                        <li>Branded Laptops and Desktop Computers</li>
                        <li>LED and Smart TVs</li>
                        <li>Computer Parts and Tech Gadgets</li>
                    </ul>
                    <p class="mt-2">Each product is inspected before dispatch to ensure it reaches you in perfect, scratch-free condition.</p>
                </div>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">Why Choose RareShop</h2>
                    <ul class="list-disc list-inside space-y-1 pl-2">
                        <li>100% Original and Verified Products</li>
                        <li>Nationwide Delivery via Trusted Couriers (TCS, M&P, Leopards, etc.)</li>
                        <li>Secure Advance Payment System (Easypaisa, NayaPay, Digi++)</li>
                        <li>30-Day Return Policy for Eligible Orders</li>
                        <li>Professional and Friendly Customer Support</li>
                    </ul>
                </div>

                <div class="policy-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">Contact Us</h2>
                    <p>For any questions, product inquiries, or support requests, feel free to contact our team:</p>
                    <ul class="list-none space-y-1 mt-2">
                        <li class="flex items-center">
                            <i class="ph ph-envelope text-xl mr-2 text-orange-600"></i>
                            <a href="mailto:businessrareshop1@gmail.com" class="hover:text-orange-600 transition-colors">businessrareshop1@gmail.com</a>
                        </li>
                        <li class="flex items-center">
                            <i class="ph ph-whatsapp-logo text-xl mr-2 text-orange-600"></i>
                            <a href="https://wa.me/923430821414" class="hover:text-orange-600 transition-colors">+92 3430821414</a>
                        </li>
                        <li class="flex items-center">
                            <i class="ph ph-clock text-xl mr-2 text-orange-600"></i>
                            <span>Hours: Monday â€“ Saturday, 10:00 AM â€“ 8:00 PM</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </template>
    <footer class="bg-gray-900 text-gray-300 py-12">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                
                <div>
                    <h3 class="text-2xl font-bold text-white mb-4">RareShop</h3>
                    <p class="text-gray-400 mb-4 text-sm">Quality tech, timeless value.</p>
                    <div class="flex space-x-4">
                        <a href="#" aria-label="Instagram" class="text-gray-400 hover:text-white transition-colors">
                            <img src="https://res.cloudinary.com/dwzfswvfy/image/upload/v1762272851/8f94c616ec0a60bafb4de4e0260719da_zvmquk.jpg" alt="Instagram" class="h-6 w-6 rounded-full"
                            onerror="this.onerror=null;this.src='https://placehold.co/24x24/e2e8f0/9ca3af?text=IG';">
                        </a>
                        <a href="#" aria-label="Facebook" class="text-gray-400 hover:text-white transition-colors">
                             <img src="https://res.cloudinary.com/dwzfswvfy/image/upload/v1762272880/images_naig4t.png" alt="Facebook" class="h-6 w-6 rounded-full"
                             onerror="this.onerror=null;this.src='https://placehold.co/24x24/e2e8f0/9ca3af?text=FB';">
                        </a>
                    </div>
                </div>

                <div>
                    <h4 class="text-lg font-semibold text-white mb-4">Quick Links</h4>
                    <ul class="space-y-2">
                        <li><a href="#" id="footer-home-link" class="text-gray-400 hover:text-white transition-colors text-sm">Home</a></li>
                        <li><a href="#" id="footer-shop-link" class="text-gray-400 hover:text-white transition-colors text-sm">Shop</a></li>
                        <li><a href="#" id="footer-about-link" class="text-gray-400 hover:text-white transition-colors text-sm">About Us</a></li>
                    </ul>
                </div>

                <div>
                    <h4 class="text-lg font-semibold text-white mb-4">Help</h4>
                    <ul class="space-y-2">
                        <li><a href="#" id="footer-faq-link" class="text-gray-400 hover:text-white transition-colors text-sm">FAQs</a></li>
                        <li><a href="#" id="footer-shipping-link" class="text-gray-400 hover:text-white transition-colors text-sm">Shipping Policy</a></li>
                        <li><a href="#" id="footer-return-link" class="text-gray-400 hover:text-white transition-colors text-sm">Return Policy</a></li>
                        <li><a href="#" id="footer-tos-link" class="text-gray-400 hover:text-white transition-colors text-sm">Terms of Service</a></li>
                    </ul>
                </div>

                <div>
                    <h4 class="text-lg font-semibold text-white mb-4">Contact</h4>
                    <ul class="space-y-2 text-sm">
                        <li class="flex items-center text-gray-400">
                            <i class="ph ph-envelope text-xl mr-2"></i>
                            <a href="mailto:businessrareshop1@gmail.com" class="hover:text-white transition-colors">businessrareshop1@gmail.com</a>
                        </li>
                        <li class="flex items-center text-gray-400">
                            <i class="ph ph-whatsapp-logo text-xl mr-2"></i>
                            <a href="httpshttps://wa.me/923430821414" class="hover:text-white transition-colors">03430821414</a>
                        </li>
                    </ul>
                </div>

            </div>
            
            <div class="border-t border-gray-700 mt-8 pt-6 text-center">
                <p class="text-gray-500 text-sm">&copy; 2025 RareShop. All rights reserved.</p>
                 <p id="user-id-display" class="text-xs text-gray-600 mt-1 hidden">User ID (for Firestore Path): Loading...</p>
            </div>
        </div>
    </footer>

    <div id="alertModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-sm w-full">
            <div class="p-6">
                <h3 id="modalTitle" class="text-lg font-medium text-gray-900">Alert</h3>
                <p id="modalMessage" class="mt-2 text-sm text-gray-600">This is an alert message.</p>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button id="modalCloseBtn" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-orange-600 text-base font-medium text-white hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 sm:ml-3 sm:w-auto sm:text-sm">
                    OK
                </button>
            </div>
        </div>
    </div>
    
    <div id="authModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-card">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h3 class="text-2xl font-bold text-gray-900" id="auth-modal-title">Sign In</h3>
                <button id="authModalCloseBtn" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="ph ph-x text-2xl"></i>
                </button>
            </div>
            
            <div class="flex justify-around mb-6 border-b border-gray-200">
                <button id="tab-login" class="tab-button active">Sign In</button>
                <button id="tab-signup" class="tab-button">Sign Up</button>
            </div>

            <div id="login-form-content">
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email address</label>
                        <input type="email" id="login-email" name="email" class="form-input" placeholder="you@example.com" required>
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="login-password" name="password" class="form-input" required>
                    </div>
                    <p id="login-error-message" class="text-sm text-red-500 hidden"></p>
                    <button type="submit" id="login-submit-btn" class="w-full py-2.5 bg-orange-600 text-white font-semibold rounded-lg shadow-md hover:bg-orange-700 transition-colors disabled:opacity-50">
                        Sign In
                    </button>
                </form>
            </div>
            
            <div id="signup-form-content" class="hidden">
                <form id="signup-form" class="space-y-4">
                    <div>
                        <label for="signup-email" class="block text-sm font-medium text-gray-700 mb-1">Email address</label>
                        <input type="email" id="signup-email" name="email" class="form-input" placeholder="newuser@example.com" required>
                    </div>
                    <div>
                        <label for="signup-password" class="block text-sm font-medium text-gray-700 mb-1">Password (min 6 characters)</label>
                        <input type="password" id="signup-password" name="password" class="form-input" required minlength="6">
                    </div>
                    <p id="signup-error-message" class="text-sm text-red-500 hidden"></p>
                    <button type="submit" id="signup-submit-btn" class="w-full py-2.5 bg-gray-900 text-white font-semibold rounded-lg shadow-md hover:bg-black transition-colors disabled:opacity-50">
                        Create Account
                    </button>
                </form>
            </div>
            
            <div class="mt-6 pt-4 border-t border-gray-200">
                <p class="text-center text-sm text-gray-500 mb-3">OR continue with</p>
                <button id="google-sign-in-btn" class="w-full py-2.5 flex items-center justify-center bg-white border border-gray-300 text-gray-700 font-semibold rounded-lg shadow-sm hover:bg-gray-50 transition-colors">
                    <img src="https://res.cloudinary.com/dqr2ewypl/image/upload/v1762591113/images_1_dxmcrp.png" alt="Google logo" class="w-5 h-5 mr-3">
                    Sign in with Google
                </button>
            </div>
        </div>
    </div>
    <script>
        const htmlElement = document.documentElement;
        const mobileSidebar = document.getElementById('mobile-sidebar');
        const sidebarBackdrop = document.getElementById('sidebar-backdrop');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const sidebarCloseBtn = document.getElementById('sidebar-close-btn');
        const sidebarThemeToggleBtn = document.getElementById('sidebar-theme-toggle-btn');


        // --- Theme Toggle Logic (Used by both inline and sidebar button) ---

        function setTheme(theme) {
            if (theme === 'dark') {
                htmlElement.classList.add('dark');
                localStorage.setItem('theme', 'dark'); 
            } else {
                htmlElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            }
        }

        // Initialize theme on load
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            setTheme(savedTheme);
        } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            setTheme('dark');
        } else {
            setTheme('light');
        }
        
        // --- Sidebar Logic ---

        function toggleSidebar() {
            const isOpen = mobileSidebar.classList.contains('open');
            
            // Toggle classes for visual effect
            mobileSidebar.classList.toggle('open', !isOpen);
            sidebarBackdrop.classList.toggle('open', !isOpen);
            sidebarBackdrop.classList.toggle('hidden', isOpen);
            
            // Prevent body scrolling when the sidebar is open
            document.body.style.overflow = isOpen ? 'hidden' : '';
        }

        // Attach listeners
        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', toggleSidebar);
        }
        if (sidebarCloseBtn) {
            sidebarCloseBtn.addEventListener('click', toggleSidebar);
        }
        if (sidebarBackdrop) {
            // Close sidebar when clicking the dark overlay
            sidebarBackdrop.addEventListener('click', toggleSidebar);
        }

        // Sidebar Theme Toggle Listener
        if (sidebarThemeToggleBtn) {
            sidebarThemeToggleBtn.addEventListener('click', () => {
                const isDarkMode = htmlElement.classList.contains('dark');
                if (isDarkMode) {
                    setTheme('light');
                } else {
                    setTheme('dark');
                }
            });
        }
        // NOTE: The WhishList and Track Order links in the sidebar are ready to be wired up to your navigation functions if needed.

    </script>
    <script type="module">
        // Import Firebase modules
        import { 
            initializeApp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword,     
            signOut,                         
            GoogleAuthProvider,             
            signInWithPopup                 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // Import Firestore modules
        import { 
            getFirestore, 
            collection, 
            onSnapshot, 
            getDoc, 
            getDocs, 
            doc, 
            query, 
            where, 
            setLogLevel, 
            setDoc, 
            updateDoc, 
            deleteDoc,
            orderBy, 
            limit,
            runTransaction 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ðŸ“¢ NEW: Import Supabase for Storage
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'; 

        // --- NEW SUPABASE CONFIG (USING YOUR CREDENTIALS) ---
        const SUPABASE_URL = 'https://cgzltxzkjadeimnbavi.supabase.co'; 
        // NOTE: Using the provided key below.
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnemx0eHpramFkZWltbmJhdmkiLCJyb2xlIjoiYW5vbiIsImlhdCI6MTcwNzQxODU2NiwiZXhwIjoxODIzMDk0NTY2fQ.eyjmb3JtYXRpYmR1cGxpY2F0ZSI6Im5vIiwiYW5vbiI6InB1YmxpYyJ9';
        const BUCKET_NAME = 'payment-proofs';
        let supabase;

        function initializeSupabase() {
            supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }
        // --- END SUPABASE CONFIG ---
        
        // --- Use Environment Variables for Config ---
        const firebaseConfigFromEnv = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const authTokenFromEnv = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appIdFromEnv = typeof __app_id !== 'undefined' ? __app_id : null;
        const userIdFromEnv = typeof __user_id !== 'undefined' ? __user_id : null;


        // --- Fallback Config ---
        const fallbackConfig = {
            apiKey: "AIzaSyA6YCRk-7wPFZfCz7YKtIX2v1I-QXqw75c",
            authDomain: "rareshop-53694.firebaseapp.com",
            projectId: "rareshop-53694",
            storageBucket: "rareshop-53694.appspot.com", 
            messagingSenderId: "431233428581",
            appId: "1:431233428581:web:a8fdf075545e62b28f2a8c",
            measurementId: "G-HKH7EYZMC5"
        };
        
        // --- Final Config and App ID ---
        const firebaseConfig = firebaseConfigFromEnv || fallbackConfig;
        const appId = appIdFromEnv || firebaseConfig.appId;

        // --- Global State and DOM Elements ---
        let app, auth, db; 
        let userId = ''; 
        let loggedInUser = null; 
        let appState = 'home'; 
        let currentTag = ''; 
        let currentCategory = ''; 
        let currentPage = 1; 
        let cartItems = {}; 
        
        const categoryItemsPerPage = 10; 

        let productListeners = []; 
        let activeTimers = {}; 
        
        // Reset payment method to null for manual selection
        let selectedPaymentMethod = null; 
        
        let carouselInterval;
        let carouselTimeout;
        let currentSlideIndex = 0;
        const SLIDE_DURATION = 4000; 

        const mainContentContainer = document.getElementById('main-content-container');
        const userIdDisplay = document.getElementById('user-id-display');
        const cartItemCountEl = document.getElementById('cart-item-count');
        
        const authModal = document.getElementById('authModal');
        const authModalCloseBtn = document.getElementById('authModalCloseBtn');
        const authModalTitle = document.getElementById('auth-modal-title');
        const tabLogin = document.getElementById('tab-login');
        const tabSignup = document.getElementById('tab-signup');
        const loginFormContent = document.getElementById('login-form-content');
        const signupFormContent = document.getElementById('signup-form-content');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const loginErrorMsg = document.getElementById('login-error-message');
        const signupErrorMsg = document.getElementById('signup-error-message');
        const authStatusContainer = document.getElementById('auth-status-container');
        const googleSignInBtn = document.getElementById('google-sign-in-btn'); 

        // --- Core Firestore Paths ---
        const PRODUCTS_COLLECTION_PATH = `artifacts/${appId}/public/data/products`; 
        const BANNERS_COLLECTION_PATH = `artifacts/${appId}/public/data/banners`;
        const ORDERS_COLLECTION_PATH = `artifacts/${appId}/public/data/orders`; 
        const CART_COLLECTION_PATH = (uid) => `artifacts/${appId}/users/${uid}/cart`; 
        const CURRENCY_SYMBOL = 'Rs.'; 


        /**
         * Clears all active Firestore listeners and timers.
         */
        function clearListeners() {
            productListeners.forEach(unsubscribe => unsubscribe());
            productListeners = [];
            
            Object.values(activeTimers).forEach(clearInterval);
            activeTimers = {};
            
            if (carouselInterval) clearInterval(carouselInterval);
            if (carouselTimeout) clearTimeout(carouselTimeout);
        }

        // --- Utility Functions ---

        /**
         * Calculates the product's effective price (discounted if sale is active).
         */
        function getEffectivePrice(product) {
            const now = new Date().getTime();
            
            const saleEndTime = product.saleEndTime ? (product.saleEndTime.toDate ? product.saleEndTime.toDate().getTime() : new Date(product.saleEndTime).getTime()) : null;
            
            const isSaleActive = saleEndTime && saleEndTime > now && product.discountPrice > 0;
            
            return isSaleActive ? (product.discountPrice || 0) : (product.price || 0);
        }

        /**
         * Returns a human-readable time difference string.
         */
        function timeSince(date) {
            if (!date) return 'N/A';
            const seconds = Math.floor((new Date() - date) / 1000);

            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutes ago";
            if (seconds < 10) return "just now";

            return Math.floor(seconds) + " seconds ago";
        }


        // --- Order Tracking Logic (NEW) ---

        /**
         * Renders the main order tracking page (list view).
         */
        function showTrackOrderView() {
            if (!loggedInUser || !loggedInUser.uid) {
                showModal("Login Required", "Please log in to view and track your orders.");
                const isOpen = mobileSidebar.classList.contains('open');
                if (isOpen) toggleSidebar();
                return;
            }

            clearListeners(); 
            appState = 'track-order';
            
            const template = document.getElementById('track-order-list-template');
            if (!template) {
                console.error("Order tracking template not found!");
                return;
            }
            const clone = document.importNode(template.content, true);
            mainContentContainer.innerHTML = '';
            mainContentContainer.appendChild(clone);
            
            const isOpen = mobileSidebar.classList.contains('open');
            if (isOpen) toggleSidebar();

            fetchAndRenderOrders();
        }

        /**
         * Fetches and renders the list of orders for the current user in real-time.
         */
        function fetchAndRenderOrders() {
            if (!db || !loggedInUser || !loggedInUser.uid) return;

            const ordersListContainer = document.getElementById('orders-list-container');
            const noOrdersMessage = document.getElementById('no-orders-message');

            const q = query(
                collection(db, ORDERS_COLLECTION_PATH),
                where("userId", "==", loggedInUser.uid),
                orderBy("orderDate", "desc"),
                limit(50) 
            );
            
            const unsubscribe = onSnapshot(q, (snapshot) => {
                const orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                ordersListContainer.innerHTML = ''; 

                if (orders.length === 0) {
                    noOrdersMessage.classList.remove('hidden');
                } else {
                    noOrdersMessage.classList.add('hidden');
                    
                    orders.forEach(order => {
                        const orderDate = order.orderDate ? (order.orderDate.toDate ? order.orderDate.toDate().toLocaleDateString() : 'N/A') : 'N/A';
                        const orderIdShort = order.id.substring(0, 8).toUpperCase();
                        
                        const orderEl = document.createElement('div');
                        orderEl.className = 'flex items-center justify-between p-4 bg-white rounded-lg shadow-sm border border-gray-200 cursor-pointer hover:bg-gray-50 transition-colors dark:bg-gray-800 dark:border-gray-700 dark:hover:bg-gray-700';
                        orderEl.setAttribute('data-order-id', order.id);

                        const statusColor = order.status === 'Payment Confirmed' ? 'text-green-600' : 
                                            (order.status === 'Pending Verification' ? 'text-yellow-600' : 'text-red-600');

                        orderEl.innerHTML = `
                            <div>
                                <h3 class="text-lg font-bold text-gray-900 dark:text-white">Order #${orderIdShort}</h3>
                                <p class="text-sm text-gray-500">Placed on ${orderDate}</p>
                            </div>
                            <div class="text-right">
                                <span class="font-bold text-xl text-orange-600">${CURRENCY_SYMBOL}${order.total.toFixed(2)}</span>
                                <p class="text-sm font-medium ${statusColor}">
                                    Status: ${order.status}
                                </p>
                            </div>
                        `;
                        
                        orderEl.addEventListener('click', () => showOrderDetailView(order));
                        
                        ordersListContainer.appendChild(orderEl);
                    });
                }
            }, (error) => {
                console.error("Error fetching orders:", error);
                ordersListContainer.innerHTML = `<p class="col-span-full p-8 text-center text-red-500">Failed to load orders. (Error: ${error.message})</p>`;
                noOrdersMessage.classList.add('hidden');
            });
            
            productListeners.push(unsubscribe); 
        }

        /**
         * Renders the specific detail page for a single order.
         */
        function showOrderDetailView(order) {
            clearListeners();
            appState = 'order-detail';

            const template = document.getElementById('order-detail-template');
            if (!template) return;

            const clone = document.importNode(template.content, true);
            mainContentContainer.innerHTML = '';
            mainContentContainer.appendChild(clone);

            document.getElementById('back-to-list-btn').addEventListener('click', showTrackOrderView);

            const orderIdShort = order.id.substring(0, 8).toUpperCase();
            document.getElementById('detail-order-id-short').textContent = `#${orderIdShort}`;

            document.getElementById('detail-customer-name').textContent = `${order.shipping.firstName} ${order.shipping.lastName}`;
            document.getElementById('detail-customer-address').textContent = `${order.shipping.address}, ${order.shipping.city}, ${order.shipping.postalCode}, ${order.shipping.country}`;
            document.getElementById('detail-customer-phone').textContent = `Phone: ${order.shipping.phone}`;
            
            document.getElementById('detail-order-date').textContent = order.orderDate ? (order.orderDate.toDate ? order.orderDate.toDate().toLocaleString() : 'N/A') : 'N/A';
            
            document.getElementById('detail-payment-method').textContent = order.paymentMethod || 'Advance Payment';
            
            const detailStatusEl = document.getElementById('detail-status');
            detailStatusEl.textContent = order.status;
            detailStatusEl.classList.remove('text-red-600', 'text-green-600', 'text-blue-600', 'text-yellow-600');

            if (order.status.includes('Pending')) {
                detailStatusEl.classList.add('text-yellow-600');
            } else if (order.status.includes('Confirmed') || order.status.includes('Shipped') || order.status.includes('Delivered')) {
                detailStatusEl.classList.add('text-green-600');
            } else {
                 detailStatusEl.classList.add('text-red-600');
            }

            const itemsContainer = document.getElementById('detail-items-container');
            itemsContainer.innerHTML = '';
            order.items.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'flex items-center space-x-4 p-3 bg-gray-100 rounded-lg dark:bg-gray-700';
                itemEl.innerHTML = `
                    <img src="${item.image || 'https://placehold.co/60x60/e2e8f0/9ca3af?text=IMG'}" 
                         alt="${item.name}" 
                         class="h-10 w-10 object-cover rounded-md flex-shrink-0"
                         onerror="this.onerror=null;this.src='https://placehold.co/60x60/e2e8f0/9ca3af?text=IMG';">
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold text-gray-900 dark:text-white">${item.name}</p>
                        <p class="text-xs text-gray-600 dark:text-gray-300">${CURRENCY_SYMBOL}${item.price.toFixed(2)} x ${item.quantity}</p>
                    </div>
                    <span class="text-sm font-bold text-gray-900 dark:text-white flex-shrink-0">${CURRENCY_SYMBOL}${(item.price * item.quantity).toFixed(2)}</span>
                `;
                itemsContainer.appendChild(itemEl);
            });

            document.getElementById('detail-total-price').textContent = `${CURRENCY_SYMBOL}${order.total.toFixed(2)}`;

            listenToSingleOrder(order.id);
        }
        
        /**
         * Attaches a real-time listener to a single order document for status updates.
         */
        function listenToSingleOrder(orderId) {
            if (!db) return;

            const orderRef = doc(db, ORDERS_COLLECTION_PATH, orderId);
            
            const unsubscribe = onSnapshot(orderRef, (docSnap) => {
                if (docSnap.exists() && appState === 'order-detail') {
                    const updatedOrder = docSnap.data();
                    const detailStatusEl = document.getElementById('detail-status');
                    
                    if (detailStatusEl && updatedOrder.status) {
                        detailStatusEl.textContent = updatedOrder.status;
                        
                        detailStatusEl.classList.remove('text-red-600', 'text-green-600', 'text-blue-600', 'text-yellow-600');
                         if (updatedOrder.status.includes('Pending')) {
                            detailStatusEl.classList.add('text-yellow-600');
                        } else if (updatedOrder.status.includes('Confirmed') || updatedOrder.status.includes('Shipped') || updatedOrder.status.includes('Delivered')) {
                            detailStatusEl.classList.add('text-green-600');
                        } else {
                             detailStatusEl.classList.add('text-red-600');
                        }
                    }
                }
            }, (error) => {
                console.error("Error listening to single order:", error);
            });

            productListeners.push(unsubscribe);
        }

        // --- Cart Logic (UPDATED) ---

        /**
         * Attaches a real-time listener to the user's cart in Firestore.
         */
        function listenToCart() {
            const currentUid = loggedInUser && loggedInUser.uid ? loggedInUser.uid : userId;

            if (!db || !currentUid) {
                console.warn("Firestore or User ID not available for cart listener.");
                return;
            }
            
            const oldCartListener = productListeners.find(l => l.isCartListener);
            if (oldCartListener) {
                oldCartListener();
                productListeners = productListeners.filter(l => l !== oldCartListener);
            }

            const q = collection(db, CART_COLLECTION_PATH(currentUid));
            
            const unsubscribe = onSnapshot(q, (snapshot) => {
                let totalCount = 0;
                let newCartItems = {};
                
                snapshot.forEach(doc => {
                    const item = { id: doc.id, ...doc.data() };
                    totalCount += item.quantity;
                    newCartItems[item.id] = item;
                });
                
                cartItems = newCartItems; 
                cartItemCountEl.textContent = totalCount; 
                
                if (appState === 'cart') {
                    renderCartView(false); 
                }
                
                if (appState === 'checkout') {
                    renderCheckoutSummary(cartItems);
                    const total = Object.values(cartItems).reduce((sum, item) => sum + (item.price * item.quantity), 0);
                    const buyNowBtn = document.getElementById('checkout-buy-now-btn');
                    if(buyNowBtn) {
                         buyNowBtn.textContent = `Place Order (${CURRENCY_SYMBOL}${total.toFixed(2)})`;
                    }
                }

            }, (error) => {
                console.error("Error listening to cart:", error);
                cartItemCountEl.textContent = 'E'; 
                showModal("Cart Error", "Failed to load cart items in real-time.");
            });
            
            unsubscribe.isCartListener = true;
            productListeners.push(unsubscribe);
        }

        /**
         * Adds or updates a product in the cart.
         */
        async function updateCart(product, change, immediateCheckout = false, showModalOnSuccess = true) {
            if (!loggedInUser || !loggedInUser.email) {
                showModal("Login Required", "Please log in or sign up to add items to your cart.");
                showAuthModal('login'); 
                return;
            }
            
            const currentUid = loggedInUser.uid;

            const currentStock = product.stock || 0;
            const existingItem = cartItems[product.id] || { quantity: 0 };
            const newQuantity = Math.max(0, existingItem.quantity + change);
            
            if (newQuantity > currentStock) {
                 showModal("Out of Stock", `The requested quantity of ${newQuantity} for ${product.name} is not available. Only ${currentStock} units are in stock.`);
                 return;
            }
            
            const effectivePrice = getEffectivePrice(product);

            try {
                const itemRef = doc(db, CART_COLLECTION_PATH(currentUid), product.id);
                
                if (newQuantity > 0) {
                    await setDoc(itemRef, {
                        productId: product.id,
                        name: product.name,
                        image: product.image,
                        price: effectivePrice, 
                        quantity: newQuantity,
                        addedAt: new Date(),
                    }, { merge: true });
                    
                    await new Promise(resolve => setTimeout(resolve, 50));

                    if (showModalOnSuccess) {
                        showModal("Item Added", `${product.name} quantity updated to ${newQuantity} in cart.`);
                    }
                } else {
                    await deleteDoc(itemRef);
                    showModal("Item Removed", `${product.name} removed from cart.`);
                }
                
                if (immediateCheckout) {
                    setTimeout(() => showCheckoutView(), 100);
                }

            } catch (error) {
                console.error("Error updating cart:", error);
                showModal("Error", `Failed to update cart: ${error.message}`);
            }
        }
        
        /**
         * Renders the cart view.
         */
        function renderCartView(clearFirst = true) {
            if (clearFirst) {
                clearListeners();
            }
            appState = 'cart';
            currentTag = '';
            currentCategory = '';
            currentPage = 1;

            const template = document.getElementById('cart-view-template');
            if (!template) {
                console.error("Cart view template not found!");
                return;
            }
            const clone = document.importNode(template.content, true);
            mainContentContainer.innerHTML = '';
            mainContentContainer.appendChild(clone);
            
            const cartItemsContainer = document.getElementById('cart-items-container');
            const summaryItemCountEl = document.getElementById('summary-item-count');
            const summarySubtotalEl = document.getElementById('summary-subtotal');
            const summaryTotalEl = document.getElementById('summary-total');
            const proceedBtn = document.getElementById('proceed-to-checkout-btn');

            let subtotal = 0;
            let totalCount = 0;
            
            cartItemsContainer.innerHTML = ''; 

            const sortedItems = Object.values(cartItems).sort((a, b) => (a.addedAt?.toDate() || 0) - (b.addedAt?.toDate() || 0));

            if (sortedItems.length > 0) {
                document.getElementById('cart-empty-message')?.remove();
                
                sortedItems.forEach(item => {
                    const price = item.price || 0;
                    const itemTotal = price * item.quantity;
                    subtotal += itemTotal;
                    totalCount += item.quantity;
                    
                    const itemEl = document.createElement('div');
                    itemEl.className = 'flex items-center space-x-4 p-4 bg-white rounded-lg shadow-sm border border-gray-200';
                    itemEl.innerHTML = `
                        <img src="${item.image || 'https://placehold.co/80x80/e2e8f0/9ca3af?text=IMG'}" 
                             alt="${item.name}" 
                             class="h-20 w-20 object-cover rounded-md flex-shrink-0"
                             onerror="this.onerror=null;this.src='https://placehold.co/80x80/e2e8f0/9ca3af?text=IMG';">
                        
                        <div class="flex-1 min-w-0">
                            <h3 class="text-lg font-semibold text-gray-900 truncate">${item.name}</h3>
                            <p class="text-sm text-gray-500">${CURRENCY_SYMBOL}${price.toFixed(2)} x ${item.quantity}</p>
                            <p class="text-base font-bold text-orange-600">${CURRENCY_SYMBOL}${itemTotal.toFixed(2)}</p>
                        </div>
                        
                        <div class="flex items-center space-x-2 flex-shrink-0">
                            <button data-id="${item.id}" data-action="decrease" class="cart-quantity-btn p-2 bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 transition-colors">
                                <i class="ph ph-minus text-lg"></i>
                            </button>
                            <span class="text-base font-medium">${item.quantity}</span>
                            <button data-id="${item.id}" data-action="increase" class="cart-quantity-btn p-2 bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 transition-colors">
                                <i class="ph ph-plus text-lg"></i>
                            </button>
                            <button data-id="${item.id}" data-action="remove" class="cart-remove-btn p-2 text-red-600 rounded-full hover:bg-red-100 transition-colors">
                                <i class="ph ph-trash-simple text-lg"></i>
                            </button>
                        </div>
                    `;
                    cartItemsContainer.appendChild(itemEl);
                });
                
                cartItemsContainer.querySelectorAll('.cart-quantity-btn, .cart-remove-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const productId = e.currentTarget.getAttribute('data-id');
                        const action = e.currentTarget.getAttribute('data-action');
                        const productData = cartItems[productId];
                        
                        if (!productData) return;
                        
                        const productRef = doc(db, PRODUCTS_COLLECTION_PATH, productId);
                        const productSnap = await getDoc(productRef);
                        
                        if (!productSnap.exists()) {
                            showModal("Error", "Product not found. Cannot modify cart item.");
                            return;
                        }
                        const product = { id: productSnap.id, ...productSnap.data() };
                        
                        let change = 0;
                        if (action === 'increase') {
                            change = 1;
                        } else if (action === 'decrease') {
                            change = -1;
                        } else if (action === 'remove') {
                            change = -productData.quantity; 
                        }
                        
                        await updateCart(product, change, false, false); 
                        
                        renderCartView(false); 
                    });
                });

            } else {
                cartItemsContainer.innerHTML = '<p class="text-gray-500 text-center p-8 border rounded-lg">Your cart is empty.</p>';
            }
            
            const total = subtotal; 
            summaryItemCountEl.textContent = totalCount;
            summarySubtotalEl.textContent = `${CURRENCY_SYMBOL}${subtotal.toFixed(2)}`;
            summaryTotalEl.textContent = `${CURRENCY_SYMBOL}${total.toFixed(2)}`;
            
            proceedBtn.disabled = totalCount === 0;

            proceedBtn.addEventListener('click', showCheckoutView);
            
            if (clearFirst && loggedInUser && loggedInUser.uid) {
                listenToCart();
            }
        }

        /**
         * Renders the checkout page.
         */
        function showCheckoutView() {
            if (!loggedInUser || !loggedInUser.email) {
                showModal("Login Required", "Please log in to proceed to checkout.");
                showAuthModal('login');
                return;
            }
            
            clearListeners(); 
            appState = 'checkout';
            
            selectedPaymentMethod = null;
            
            const template = document.getElementById('checkout-view-template');
            if (!template) {
                console.error("Checkout view template not found!");
                return;
            }
            const clone = document.importNode(template.content, true);
            mainContentContainer.innerHTML = '';
            mainContentContainer.appendChild(clone);
            
            const contactEmailInput = document.getElementById('contact-email');
            if (contactEmailInput && loggedInUser.email) {
                contactEmailInput.value = loggedInUser.email;
                contactEmailInput.readOnly = true; 
                contactEmailInput.classList.add('bg-gray-100');
            }
            
            const total = Object.values(cartItems).reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('checkout-buy-now-btn').textContent = `Place Order (${CURRENCY_SYMBOL}${total.toFixed(2)})`;

            renderCheckoutSummary(cartItems);
            listenToCart(); 

            document.getElementById('return-to-cart-link').addEventListener('click', (e) => {
                e.preventDefault();
                renderCartView(true); 
            });

            setupCheckoutFormListeners(total);
        }

        /**
         * Renders the Order Summary on the Checkout page.
         */
        function renderCheckoutSummary(items) {
            const container = document.getElementById('checkout-summary-content');
            if (!container) return;
            
            const itemArray = Object.values(items);
            let subtotal = 0;
            let totalCount = 0;
            let html = '';

            itemArray.forEach(item => {
                const price = item.price || 0;
                const itemTotal = price * item.quantity;
                subtotal += itemTotal;
                totalCount += item.quantity;
                
                html += `
                    <div class="flex items-center space-x-3 py-2 border-b border-gray-100">
                        <div class="relative flex-shrink-0">
                            <img src="${item.image || 'https://placehold.co/40x40/e2e8f0/9ca3af?text=IMG'}" 
                                 alt="${item.name}" 
                                 class="h-10 w-10 object-cover rounded-md border"
                                 onerror="this.onerror=null;this.src='https://placehold.co/40x40/e2e8f0/9ca3af?text=IMG';">
                            <span class="absolute -top-2 -right-2 h-5 w-5 bg-orange-600 text-white text-xs rounded-full flex items-center justify-center">${item.quantity}</span>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-800 truncate">${item.name}</p>
                            <p class="text-xs text-gray-500">${CURRENCY_SYMBOL}${price.toFixed(2)}</p>
                        </div>
                        <span class="text-sm font-semibold text-gray-900">${CURRENCY_SYMBOL}${itemTotal.toFixed(2)}</span>
                    </div>
                `;
            });

            const total = subtotal; 
            
            html += `
                <div class="space-y-3 mt-4 text-gray-700">
                    <div class="flex justify-between">
                        <span>Subtotal (${totalCount} items)</span>
                        <span class="font-medium">${CURRENCY_SYMBOL}${subtotal.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Shipping</span>
                        <span class="font-medium text-green-600">FREE</span>
                    </div>
                    <div class="flex justify-between border-t pt-3 border-gray-300 text-lg font-bold text-gray-900">
                        <span>Total</span>
                        <span>${CURRENCY_SYMBOL}${total.toFixed(2)}</span>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        /**
         * Sets up listeners for the checkout form, including payment method selection and file upload.
         */
        function setupCheckoutFormListeners(currentTotal) {
            const form = document.getElementById('checkout-form');
            const buyNowBtn = document.getElementById('checkout-buy-now-btn');
            const paymentLogos = document.querySelectorAll('.payment-logo');
            const instructionsContainer = document.getElementById('payment-instructions-container');
            const instructionsHeading = document.getElementById('payment-instructions-heading');
            const instructionsText = document.getElementById('payment-instructions-text');
            const screenshotFile = document.getElementById('payment-screenshot-file');
            
            // --- Payment Method Selection ---
            paymentLogos.forEach(logo => {
                logo.addEventListener('click', () => {
                    paymentLogos.forEach(l => l.classList.remove('selected'));
                    
                    logo.classList.add('selected');
                    selectedPaymentMethod = logo.getAttribute('data-method');
                    
                    instructionsHeading.textContent = logo.getAttribute('data-heading');
                    instructionsText.textContent = logo.getAttribute('data-instructions');
                    instructionsContainer.classList.remove('hidden');
                    
                    updateBuyNowButtonState();
                });
            });

            // --- Form Input Listener (for validation) ---
            form.addEventListener('input', updateBuyNowButtonState);
            screenshotFile?.addEventListener('change', updateBuyNowButtonState);


            function updateBuyNowButtonState() {
                const isFormValid = form.checkValidity();
                const isPaymentSelected = selectedPaymentMethod !== null;
                const isFileSelected = screenshotFile?.files.length > 0;
                const total = Object.values(cartItems).reduce((sum, item) => sum + (item.price * item.quantity), 0);
                
                buyNowBtn.disabled = !(isFormValid && isPaymentSelected && isFileSelected);
                buyNowBtn.textContent = `Place Order (${CURRENCY_SYMBOL}${total.toFixed(2)})`;
            }
            
            updateBuyNowButtonState();

            // --- Form Submission (Final Step with Supabase Upload) ---
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (buyNowBtn.disabled) {
                    showModal("Missing Information", "Please fill out all required fields, select a payment method, and upload the payment screenshot.");
                    return;
                }
                
                if (!loggedInUser || !loggedInUser.uid) {
                    showModal("Authentication Error", "You must be logged in to place an order. Please sign in again.");
                    buyNowBtn.disabled = false;
                    return;
                }
                
                const finalOrderTotal = Object.values(cartItems).reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const cartItemsArray = Object.values(cartItems);

                if (cartItemsArray.length === 0 || finalOrderTotal === 0) {
                     showModal("Cart Empty", "Your cart is empty. Please add items before placing an order.");
                     return;
                }

                // --- ðŸ“¢ SUPABASE FILE UPLOAD LOGIC START ---
                const fileToUpload = screenshotFile.files[0];
                const uploadStatusEl = document.getElementById('upload-status');
                
                if (!fileToUpload) { 
                    showModal("Missing Proof", "Please upload a payment screenshot to proceed.");
                    return;
                }

                // Disable button and show loading state
                buyNowBtn.disabled = true;
                buyNowBtn.innerHTML = '<i class="ph ph-spinner-gap animate-spin mr-2"></i> Uploading Screenshot...';
                uploadStatusEl.textContent = 'Uploading file...';
                uploadStatusEl.classList.remove('hidden');

                let downloadURL = null;
                try {
                    const fileExtension = fileToUpload.name.split('.').pop();
                    const filePath = `${loggedInUser.uid}/${Date.now()}_${Math.random().toString(36).substring(2, 8)}.${fileExtension}`; 

                    // 1. UPLOAD FILE using Supabase Storage
                    const { error } = await supabase.storage
                        .from(BUCKET_NAME)
                        .upload(filePath, fileToUpload, {
                            cacheControl: '3600', 
                            upsert: false 
                        });
                    
                    if (error) throw error;
                    
                    // 2. CONSTRUCT PUBLIC URL
                    downloadURL = `${SUPABASE_URL}/storage/v1/object/public/${BUCKET_NAME}/${filePath}`;

                    uploadStatusEl.textContent = 'Upload complete.';

                } catch (error) {
                    console.error("Storage Upload Error:", error);
                    showModal("Upload Error", `Failed to upload payment proof: ${error.message}. Please check your Supabase bucket settings.`);
                    buyNowBtn.disabled = false;
                    buyNowBtn.textContent = `Place Order (${CURRENCY_SYMBOL}${finalOrderTotal.toFixed(2)})`;
                    uploadStatusEl.textContent = 'Upload failed. Try again.';
                    return;
                }
                // --- ðŸ“¢ SUPABASE FILE UPLOAD LOGIC END ---

                const ordersCollectionPath = `artifacts/${appId}/public/data/orders`;
                const newOrderRef = doc(collection(db, ordersCollectionPath));
                
                try {
                    // --- Atomic Stock Decrement via Transaction ---
                    buyNowBtn.innerHTML = '<i class="ph ph-spinner-gap animate-spin mr-2"></i> Checking Stock...';

                    await runTransaction(db, async (transaction) => {
                        const productUpdates = [];
                        
                        for (const item of cartItemsArray) {
                            const productRef = doc(db, PRODUCTS_COLLECTION_PATH, item.productId);
                            const productSnap = await transaction.get(productRef);
                            
                            if (!productSnap.exists()) {
                                throw new Error(`Product ${item.name} not found.`);
                            }
                            
                            const currentStock = productSnap.data().stock || 0;
                            const neededQuantity = item.quantity;
                            const newStock = currentStock - neededQuantity;
                            
                            if (newStock < 0) {
                                throw new Error(`Insufficient stock for ${item.name}. Only ${currentStock} available.`);
                            }
                            
                            productUpdates.push({
                                ref: productRef,
                                newStock: newStock,
                                availability: newStock > 0 ? 'In Stock' : 'Out of Stock'
                            });
                        }
                        
                        productUpdates.forEach(update => {
                            transaction.update(update.ref, { 
                                stock: update.newStock,
                                'details.availability': update.availability
                            });
                        });
                        
                        // 3. Place the order, saving the URL
                        buyNowBtn.innerHTML = '<i class="ph ph-spinner-gap animate-spin mr-2"></i> Placing Order...';
                        const orderData = {
                            userId: loggedInUser.uid,
                            items: cartItemsArray.map(item => ({...item, addedAt: null})), 
                            total: finalOrderTotal,
                            contact: form.elements['contact-email'].value,
                            shipping: {
                                firstName: form.elements['shipping-first-name'].value,
                                lastName: form.elements['shipping-last-name'].value,
                                address: form.elements['shipping-address'].value,
                                apartment: form.elements['shipping-apartment'].value,
                                city: form.elements['shipping-city'].value,
                                postalCode: form.elements['shipping-postal-code'].value,
                                phone: form.elements['shipping-phone'].value,
                                country: form.elements['shipping-country'].value,
                            },
                            paymentMethod: selectedPaymentMethod,
                            paymentProofUrl: downloadURL, // ðŸ“¢ SAVING THE UPLOADED URL
                            status: 'Pending Verification', 
                            orderDate: new Date(),
                        };
                        transaction.set(newOrderRef, orderData); 
                    });
                    
                    // 4. Clear the cart AFTER successful transaction
                    buyNowBtn.innerHTML = '<i class="ph ph-spinner-gap animate-spin mr-2"></i> Clearing Cart...';
                    const cartRefs = await getDocs(collection(db, CART_COLLECTION_PATH(loggedInUser.uid)));
                    const deletePromises = [];
                    cartRefs.forEach(doc => {
                        deletePromises.push(deleteDoc(doc.ref));
                    });
                    await Promise.all(deletePromises);
                    
                    // 5. Success message and redirect
                    showModal("Order Placed!", `Your order #${newOrderRef.id.substring(0, 8).toUpperCase()} has been placed and is now **Pending Verification**. Please wait for confirmation.`);
                    renderHomeView(); 

                } catch (error) {
                    console.error("Error placing order/stock update:", error);
                    let displayMessage = error.message.includes('Insufficient stock') ? error.message : `Failed to place order: ${error.message}.`;
                    
                    showModal("Order Error", displayMessage);
                    buyNowBtn.disabled = false;
                    buyNowBtn.textContent = `Place Order (${CURRENCY_SYMBOL}${finalOrderTotal.toFixed(2)})`;
                }
            });
        }

        // --- Countdown Timer Functions (Unchanged) ---

        /**
         * Formats the remaining time until an end date.
         */
        function formatTimeRemaining(endTime) {
            const total = endTime.getTime() - new Date().getTime();
            
            if (total <= 0) {
                return { days: 0, hours: 0, minutes: 0, seconds: 0, total: 0 };
            }

            const seconds = Math.floor((total / 1000) % 60);
            const minutes = Math.floor((total / 1000 / 60) % 60);
            const hours = Math.floor((total / (1000 * 60 * 60)) % 24);
            const days = Math.floor(total / (1000 * 60 * 60 * 24));

            return {
                days: days,
                hours: hours,
                minutes: minutes,
                seconds: seconds,
                total: total
            };
        }

        /**
         * Starts a countdown timer for the product detail page.
         */
        function startDetailCountdown(product, endTime) {
            const timerContainer = document.getElementById('product-sale-timer-container');
            const priceContainer = document.getElementById('price-display-wrapper');
            if (!timerContainer || !priceContainer) return;

            if (activeTimers[product.id]) {
                clearInterval(activeTimers[product.id]);
            }

            const timerInterval = setInterval(() => {
                const time = formatTimeRemaining(endTime);

                if (time.total <= 0) {
                    clearInterval(timerInterval);
                    delete activeTimers[product.id];
                    
                    timerContainer.innerHTML = '';
                    
                    const originalPrice = (product.price || 0).toFixed(2);
                    priceContainer.innerHTML = `
                        <span class="text-4xl font-bold text-orange-600">${CURRENCY_SYMBOL}${originalPrice}</span>
                    `;
                } else {
                    timerContainer.innerHTML = `
                        <div class="detail-sale-timer">
                            <h3 class="detail-sale-timer-title">
                                <i class="ph ph-clock-countdown text-lg align-middle mr-1"></i>
                                Flash Sale Ends In:
                            </h3>
                            <div class="detail-sale-timer-time">
                                <div class="detail-sale-timer-block">
                                    <span class="detail-sale-timer-num">${String(time.days).padStart(2, '0')}</span>
                                    <span class="detail-sale-timer-label">Days</span>
                                </div>
                                <div class="detail-sale-timer-block">
                                    <span class="detail-sale-timer-num">${String(time.hours).padStart(2, '0')}</span>
                                    <span class="detail-sale-timer-label">Hours</span>
                                </div>
                                <div class="detail-sale-timer-block">
                                    <span class="detail-sale-timer-num">${String(time.minutes).padStart(2, '0')}</span>
                                    <span class="detail-sale-timer-label">Mins</span>
                                </div>
                                <div class="detail-sale-timer-block">
                                    <span class="detail-sale-timer-num">${String(time.seconds).padStart(2, '0')}</span>
                                    <span class="detail-sale-timer-label">Secs</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }, 1000);

            activeTimers[product.id] = timerInterval;
        }

        // --- Carousel Functions (Unchanged) ---

        /**
         * Moves the carousel to a specific slide.
         */
        function moveToSlide(slideIndex) {
            const track = document.querySelector('.carousel-track');
            const dots = document.querySelectorAll('.carousel-dot');
            if (!track || !dots.length) return;
            
            const totalSlides = dots.length;
            
            currentSlideIndex = (slideIndex + totalSlides) % totalSlides;
            
            track.style.transform = `translateX(-${currentSlideIndex * 100}%)`;
            
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === currentSlideIndex);
            });
        }

        /**
         * Starts the automatic carousel timer.
         */
        function startCarousel() {
            stopCarousel(); 
            carouselInterval = setInterval(() => {
                moveToSlide(currentSlideIndex + 1);
            }, SLIDE_DURATION);
        }

        /**
         * Stops the automatic carousel timer.
         */
        function stopCarousel() {
            if (carouselInterval) clearInterval(carouselInterval);
            if (carouselTimeout) clearTimeout(carouselTimeout);
        }
        
        /**
         * Initializes the carousel elements and listeners.
         */
        function initializeCarousel() {
            const carousel = document.getElementById('image-carousel');
            const track = carousel?.querySelector('.carousel-track');
            const slides = carousel?.querySelectorAll('.carousel-slide');
            const dotsContainer = document.getElementById('carousel-dots-container');

            if (!carousel || !track || !slides || !dotsContainer || slides.length === 0) return;

            dotsContainer.innerHTML = '';
            slides.forEach((_, index) => {
                const dot = document.createElement('button');
                dot.classList.add('carousel-dot');
                if (index === 0) dot.classList.add('active');
                dot.setAttribute('aria-label', `Go to slide ${index + 1}`);
                dot.addEventListener('click', () => {
                    moveToSlide(index);
                    stopCarousel();
                    startCarousel();
                });
                dotsContainer.appendChild(dot);
            });

            slides.forEach((slide) => {
                const tag = slide.getAttribute('data-link-tag');
                if (tag) {
                    slide.addEventListener('click', () => {
                        showProductListing(tag);
                    });
                }
            });
            
            ['mousedown', 'touchstart'].forEach(event => {
                carousel.addEventListener(event, () => {
                    stopCarousel();
                });
            });
            
            ['mouseup', 'mouseleave', 'touchend'].forEach(event => {
                 carousel.addEventListener(event, () => {
                    stopCarousel(); 
                    startCarousel();
                });
            });

            moveToSlide(0);
            startCarousel();
        }
        
        /**
         * Fetches banners from Firestore and populates the carousel.
         */
        function fetchBanners() {
            if (!db) return;
            const q = query(collection(db, BANNERS_COLLECTION_PATH));

            const unsubscribe = onSnapshot(q, (snapshot) => {
                const banners = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                banners.sort((a, b) => (a.order || 0) - (b.order || 0));
                
                const track = document.querySelector('.carousel-track');
                if (!track) return;
                
                track.innerHTML = ''; 

                if (banners.length > 0) {
                    banners.forEach(banner => {
                        const slide = document.createElement('div');
                        slide.className = 'carousel-slide';
                        slide.setAttribute('data-link-tag', banner.linkTag || '');
                        slide.innerHTML = `
                            <img src="${banner.imageUrl}" 
                                 alt="${banner.altText || 'Homepage Banner'}"
                                 onerror="this.onerror=null;this.src='https://placehold.co/1200x400/e2e8f0/9ca3af?text=Banner+Error';">
                        `;
                        track.appendChild(slide);
                    });
                } else {
                    track.innerHTML = `
                        <div class="carousel-slide" data-link-tag="featured">
                            <img src="https://placehold.co/1200x400/e2e8f0/9ca3af?text=Welcome+to+RareShop" 
                                 alt="Welcome to RareShop">
                        </div>
                    `;
                }
                
                initializeCarousel();

            }, (error) => {
                console.error("Error fetching banners:", error);
                const track = document.querySelector('.carousel-track');
                if (track) {
                    track.innerHTML = `
                        <div class="carousel-slide">
                            <img src="https://placehold.co/1200x400/e2e8f0/9ca3af?text=Error+Loading+Banners" 
                                 alt="Error loading banners">
                        </div>
                    `;
                }
                initializeCarousel();
            });
            
            productListeners.push(unsubscribe); 
        }


        /**
         * Renders the home view.
         */
        function renderHomeView() {
            clearListeners(); 
            appState = 'home';
            currentTag = '';
            currentCategory = '';
            currentPage = 1;

            const template = document.getElementById('home-view-template');
            if (!template) {
                console.error("Home view template not found!");
                return;
            }
            const clone = document.importNode(template.content, true);
            mainContentContainer.innerHTML = '';
            mainContentContainer.appendChild(clone);

            fetchBanners();

            const featuredProductsList = document.getElementById('featured-products-list');
            const topSalesList = document.getElementById('top-sales-list');
            const mostPopularList = document.getElementById('most-popular-list');
            
            const featuredViewMore = document.getElementById('featured-products-view-more');
            const topSalesViewMore = document.getElementById('top-sales-view-more');
            const mostPopularViewMore = document.getElementById('most-popular-view-more');

            renderPlaceholderSection(featuredProductsList, featuredViewMore, 6);
            fetchProductsByTag('featured', featuredProductsList, featuredViewMore, "No featured products available.", false);
            
            renderPlaceholderSection(topSalesList, topSalesViewMore, 6);
            fetchProductsByTag('top-sales', topSalesList, topSalesViewMore, "No top sales available.", false);
            
            renderPlaceholderSection(mostPopularList, mostPopularViewMore, 6);
            fetchProductsByTag('most-popular', mostPopularList, mostPopularViewMore, "No popular products available.", false);
            
            document.querySelectorAll('.view-more-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tag = link.getAttribute('data-tag');
                    if (tag) {
                        showProductListing(tag); 
                    }
                });
            });

            document.querySelectorAll('.category-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const category = link.getAttribute('data-category');
                    if (category) {
                        showCategoryListing(category); 
                    }
                });
            });
        }
        
        /**
         * Renders the "View More" product listing page.
         */
        function showProductListing(tag) {
            clearListeners();
            appState = 'listing';
            currentTag = tag;
            currentCategory = ''; 
            
            const titleMap = {
                'featured': 'Featured Products',
                'top-sales': 'Top Sales',
                'most-popular': 'Most Popular'
            };
            const title = titleMap[tag] || 'Product Listing';

            const template = document.getElementById('listing-view-template');
            if (!template) {
                console.error("Listing view template not found!");
                return;
            }
            const clone = document.importNode(template.content, true);
            mainContentContainer.innerHTML = '';
            mainContentContainer.appendChild(clone);
            
            document.getElementById('listing-page-title').textContent = title;

            const listingGrid = document.getElementById('listing-products-grid');

            renderPlaceholderSection(listingGrid, null, 20); 
            fetchProductsByTag(tag, listingGrid, null, "No products found for this tag.", true); 
            
            document.getElementById('back-to-home-btn-listing').addEventListener('click', renderHomeView);
        }

        /**
         * Renders the paginated Category listing page.
         */
        function showCategoryListing(category) {
            clearListeners();
            appState = 'category';
            currentCategory = category;
            currentPage = 1; 

            const template = document.getElementById('category-listing-template');
            if (!template) {
                console.error("Category listing template not found!");
                return;
            }
            const clone = document.importNode(template.content, true);
            mainContentContainer.innerHTML = '';
            mainContentContainer.appendChild(clone);

            document.getElementById('category-page-title').textContent = category;

            fetchProductsByCategory(currentCategory, currentPage, categoryItemsPerPage);

            document.getElementById('back-to-home-btn-category').addEventListener('click', renderHomeView);
            
            document.getElementById('prev-page-btn').addEventListener('click', () => {
                 if (currentPage > 1) {
                    currentPage--;
                    fetchProductsByCategory(currentCategory, currentPage, categoryItemsPerPage);
                }
            });
            
            document.getElementById('next-page-btn').addEventListener('click', () => {
                currentPage++;
                fetchProductsByCategory(currentCategory, currentPage, categoryItemsPerPage);
            });
        }

        /**
         * Fetches products based on a tag and renders them.
         */
        function fetchProductsByTag(tag, container, viewMoreElement, errorMsg, isListingPage = false) {
            if (!db) return;
            const q = query(collection(db, PRODUCTS_COLLECTION_PATH), where("tag", "array-contains", tag));
            
            const unsubscribe = onSnapshot(q, (snapshot) => {
                const products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProducts(products, container, viewMoreElement, errorMsg, isListingPage);
            }, (error) => {
                console.error(`Error fetching products for tag '${tag}':`, error);
                container.innerHTML = `<p class="col-span-full p-8 text-center text-red-500">${errorMsg} (Error: ${error.message})</p>`;
            });
            productListeners.push(unsubscribe);
        }

        /**
         * Fetches products based on category with pagination.
         */
        function fetchProductsByCategory(category, page, itemsPerPage) {
            if (!db) return;
            const grid = document.getElementById('category-products-grid');
            const pageInfo = document.getElementById('page-info');
            const nextBtn = document.getElementById('next-page-btn');
            const prevBtn = document.getElementById('prev-page-btn');
            
            if (!grid || !pageInfo || !nextBtn || !prevBtn) {
                 console.error("Pagination or grid elements not found.");
                 return;
            }
            
            renderPlaceholderSection(grid, null, itemsPerPage); 

            const q = query(collection(db, PRODUCTS_COLLECTION_PATH), where("category", "==", category));
            
            const unsubscribe = onSnapshot(q, (snapshot) => {
                let products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const totalProducts = products.length;
                const totalPages = Math.ceil(totalProducts / itemsPerPage) || 1; 
                
                pageInfo.textContent = `Page ${page} of ${totalPages}`;
                prevBtn.disabled = (page === 1);
                nextBtn.disabled = (page === totalPages);

                const startIndex = (page - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const pagedProducts = products.slice(startIndex, endIndex);

                renderProducts(pagedProducts, grid, null, "No products found in this category.", true);
                
            }, (error) => {
                console.error(`Error fetching products for category '${category}':`, error);
                grid.innerHTML = `<p class="col-span-full p-8 text-center text-red-500">Error loading products. (Error: ${error.message})</p>`;
            });
            
            productListeners.push(unsubscribe);
        }


        /**
         * Generates the HTML for a single, empty product card placeholder.
         */
        function renderPlaceholderCard() {
            return `
                <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden group cursor-default animate-pulse product-card-animation transition-all duration-300">
                    <div class="block">
                        <div class="w-full h-40 sm:h-48 bg-gray-200 flex items-center justify-center text-gray-400 rounded-t-lg">
                            <i class="ph ph-image-square text-4xl"></i>
                        </div>
                    </div>
                    <div class="p-4">
                        <div class="h-4 bg-gray-300 rounded w-full mb-2"></div>
                        <div class="h-3 bg-gray-200 rounded w-1/2 mb-3"></div>
                        <div class="h-5 bg-orange-200 rounded w-1/3"></div>
                    </div>
                </div>
            `;
        }

        /**
         * Renders a specific number of placeholder cards into a container.
         */
        function renderPlaceholderSection(container, viewMoreElement, count) {
            if (!container) {
                console.error("Placeholder container not found.");
                return; 
            }
            
            container.innerHTML = '';
            let html = '';
            for (let i = 0; i < count; i++) {
                html += `<div style="animation: fadeIn 0.4s ease-out forwards; animation-delay: ${i * 0.05}s; opacity: 0;">${renderPlaceholderCard()}</div>`;
            }
            container.innerHTML = html;
            
            if (viewMoreElement && viewMoreElement.classList) {
                viewMoreElement.classList.remove('hidden');
            }
        }

        /**
         * Renders a list of products into a specified container (Handles Real Data).
         */
        function renderProducts(products, container, viewMoreElement, errorMsg, isListingPage = false) {
            
            if (!container) {
                console.error("Render container not found.");
                return; 
            }
            container.innerHTML = ''; 

            if (!products || products.length === 0) {
                container.innerHTML = `<p class="col-span-full p-8 text-center text-gray-500">${errorMsg}</p>`;
                if (viewMoreElement && viewMoreElement.classList) viewMoreElement.classList.add('hidden');
                return;
            }

            const productsToShow = isListingPage ? products : products.slice(0, 6);
            
            if (viewMoreElement && viewMoreElement.classList) {
                if (products.length > 6) {
                    viewMoreElement.classList.remove('hidden');
                } else {
                    viewMoreElement.classList.add('hidden');
                }
            }


            productsToShow.forEach(product => {
                const productEl = document.createElement('div');
                productEl.className = 'bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden group transition-all duration-300 hover:shadow-md cursor-pointer product-card-animation';
                
                const originalPrice = (product.price || 0).toFixed(2);
                const discountPrice = (product.discountPrice > 0 ? product.discountPrice : null);
                
                const saleEndTime = product.saleEndTime ? (product.saleEndTime.toDate ? product.saleEndTime.toDate() : new Date(product.saleEndTime)) : null;
                const isSaleActive = saleEndTime && saleEndTime.getTime() > new Date().getTime() && discountPrice;
                
                const currentStock = product.stock || 0;
                const isOutOfStock = (product.stock || 0) <= 0;

                let priceHtml;
                if (isSaleActive) {
                    priceHtml = `
                        <div class="flex flex-col items-start space-y-0.5 mt-1">
                            <span class="original-price">${CURRENCY_SYMBOL}${originalPrice}</span>
                            <span class="discount-price text-base sm:text-lg">${CURRENCY_SYMBOL}${discountPrice.toFixed(2)}</span>
                        </div>
                    `;
                } else {
                    priceHtml = `<p class="text-base sm:text-lg font-bold text-orange-600">${CURRENCY_SYMBOL}${originalPrice}</p>`;
                }
                
                if (isOutOfStock) {
                     priceHtml = `<p class="text-base sm:text-lg font-bold text-red-600">Out of Stock</p>`;
                }

                productEl.addEventListener('click', (e) => {
                    e.preventDefault();
                    showProductDetail(product.id);
                });
                
                const productTags = Array.isArray(product.tag) ? product.tag : [];
                const tagHtml = productTags.map(tag => 
                    `<span class="inline-block bg-orange-100 text-orange-600 text-xs font-medium px-2.5 py-0.5 rounded-full mt-2">${tag.toUpperCase().replace('-', ' ')}</span>`
                ).join(' ');


                const primaryImage = product.image || 'https://placehold.co/400x300/e2e8f0/9ca3af?text=RareShop+Product';
                
                const secondaryImageHtml = product.image2 ? `
                    <img 
                        src="${product.image2}" 
                        alt="${product.name} (hover)" 
                        class="absolute inset-0 w-full h-full object-cover transition-all duration-300 opacity-0 group-hover:opacity-100 group-hover:scale-105"
                        onerror="this.onerror=null;this.style.display='none';"
                    >
                ` : '';


                productEl.innerHTML = `
                    <div class="relative block w-full h-40 sm:h-48 overflow-hidden rounded-t-lg bg-gray-200">
                        <img 
                            src="${primaryImage}" 
                            alt="${product.name}" 
                            class="absolute inset-0 w-full h-full object-cover transition-all duration-300 ${product.image2 ? 'opacity-100 group-hover:opacity-0' : 'group-hover:scale-105'}"
                            onerror="this.onerror=null;this.src='https://placehold.co/400x300/e2e8f0/9ca3af?text=Img+Error';"
                        >
                        ${secondaryImageHtml}
                    </div>
                    <div class="p-4">
                        <h3 class="text-sm sm:text-base font-semibold text-gray-800 truncate" title="${product.name}">
                            ${product.name}
                        </h3>
                        <p class="text-xs text-gray-500 mb-2">${product.category || 'Uncategorized'}</p>
                        ${priceHtml}
                        ${tagHtml}
                    </div>
                `;
                container.appendChild(productEl);
            });
        }

        /**
         * Renders the product detail page for a given product ID.
         */
        async function showProductDetail(productId) {
            clearListeners(); 
            appState = 'detail';
            
            const template = document.getElementById('detail-view-template');
            if (!template) {
                console.error("Detail view template not found!");
                return;
            }
            const clone = document.importNode(template.content, true);
            mainContentContainer.innerHTML = '';
            mainContentContainer.appendChild(clone);
            
            const detailWrapper = document.getElementById('detail-content-wrapper');
            detailWrapper.innerHTML = `
                <div class="col-span-full p-8 text-center text-gray-500">
                    <i class="ph ph-spinner-gap text-4xl animate-spin mr-2"></i> Loading product details...
                </div>
            `;

            try {
                const docRef = doc(db, PRODUCTS_COLLECTION_PATH, productId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const unsubscribe = onSnapshot(docRef, (doc) => {
                        if (doc.exists()) {
                            renderDetailPage({ id: doc.id, ...doc.data() });
                        } else {
                             detailWrapper.innerHTML = '<div class="col-span-full p-8 text-center text-red-500 text-xl">Product not found.</div>';
                        }
                    }, (error) => {
                        console.error("Error listening to product detail:", error);
                        showModal("Error", "Failed to load product details in real-time.");
                    });
                    productListeners.push(unsubscribe);

                } else {
                    detailWrapper.innerHTML = '<div class="col-span-full p-8 text-center text-red-500 text-xl">Product not found.</div>';
                }
            } catch (error) {
                console.error("Error fetching product detail:", error);
                detailWrapper.innerHTML = `<div class="col-span-full p-8 text-center text-red-500 text-xl">Failed to load product: ${error.message}</div>`;
            }
        }
        
        /**
         * Generates the HTML for the product detail page, handling discount prices and PKR currency.
         */
        function renderDetailPage(product) {
            const details = product.details || {};
            const detailWrapper = document.getElementById('detail-content-wrapper');
            if (!detailWrapper) return; 
            
            function createSpecRow(label, value) {
                if (!value || value.trim() === '') return ''; 
                return `<tr class="border-b border-gray-100">
                            <td class="py-2 px-4 bg-gray-50 text-sm font-medium text-gray-600 w-1/3">${label}</td>
                            <td class="py-2 px-4 text-sm text-gray-800 break-words">${value}</td>
                        </tr>`;
            }
            function createSpecHeader(title) {
                return `<tr class="bg-gray-200">
                            <th class="py-2 px-4 text-left text-sm font-semibold text-gray-700" colspan="2">${title}</th>
                        </tr>`;
            }

            const specs = details.specs || {};
            const proc = specs.processor || {};
            const mem = specs.memory || {};
            const graph = specs.graphics || {};
            const disp = specs.display || {};
            const feat = specs.features || {};

            let specsHtml = '<table class="w-full border border-gray-200 rounded-lg overflow-hidden table-fixed">';
            
            specsHtml += createSpecHeader("General");
            specsHtml += createSpecRow("Brand", specs.brand);
            specsHtml += createSpecRow("Warranty", specs.warranty);
            specsHtml += createSpecRow("Condition", specs.condition);
            specsHtml += createSpecRow("Operating System", specs.os);
            specsHtml += createSpecRow("Weight", specs.weight);
            
            specsHtml += createSpecHeader("Processor");
            specsHtml += createSpecRow("Generation", proc.generation);
            specsHtml += createSpecRow("Processor Type", proc.type);
            specsHtml += createSpecRow("Processor Speed", proc.speed);
            
            specsHtml += createSpecHeader("Memory & Storage");
            specsHtml += createSpecRow("Installed RAM", mem.ram);
            specsHtml += createSpecRow("RAM Type", mem.ramType);
            specsHtml += createSpecRow("Hard Drive", mem.hdd);
            specsHtml += createSpecRow("Hard Drive Speed", mem.hddSpeed);
            specsHtml += createSpecRow("SSD", mem.ssd);
            specsHtml += createSpecRow("Storage Type", mem.driveType);
            specsHtml += createSpecRow("Optical Drive", mem.optical);
            specsHtml += createSpecRow("Optical Drive Type", mem.opticalType);
            
            specsHtml += createSpecHeader("Graphics & Display");
            specsHtml += createSpecRow("Graphics Series", graph.series);
            specsHtml += createSpecRow("Dedicated Graphics", graph.dedicated);
            specsHtml += createSpecRow("Graphics Memory", graph.memory);
            specsHtml += createSpecRow("Graphics Memory Type", graph.memoryType);
            specsHtml += createSpecRow("Switchable Graphics", graph.switchable);
            specsHtml += createSpecRow("Graphics Processor", graph.processor);
            specsHtml += createSpecRow("Screen Size", disp.size);
            specsHtml += createSpecRow("Screen Surface", disp.surface);
            specsHtml += createSpecRow("Screen Resolution", disp.resolution);
            specsHtml += createSpecRow("Touchscreen", disp.touch);
            specsHtml += createSpecRow("Backlight", disp.backlight);
            
            specsHtml += createSpecHeader("Features & Connectivity");
            specsHtml += createSpecRow("Color", feat.color);
            specsHtml += createSpecRow("RAM (Form)", feat.ram); 
            specsHtml += createSpecRow("Fingerprint Reader", feat.fingerprint);
            specsHtml += createSpecRow("Numeric Keyboard", feat.numKeyboard);
            specsHtml += createSpecRow("Backlit Keyboard", feat.backlitKeyboard);
            specsHtml += createSpecRow("Bluetooth", feat.bluetooth);
            specsHtml += createSpecRow("LAN", feat.lan);
            specsHtml += createSpecRow("Wireless/Wifi", feat.wifi);
            
            specsHtml += '</table>';
                
            const originalPrice = (product.price || 0).toFixed(2);
            const discountPrice = (product.discountPrice > 0 ? product.discountPrice : null);
            
            const saleEndTime = product.saleEndTime ? (product.saleEndTime.toDate ? product.saleEndTime.toDate() : new Date(product.saleEndTime)) : null;
            const isSaleActive = saleEndTime && saleEndTime.getTime() > new Date().getTime() && discountPrice;
            
            const currentStock = product.stock || 0;
            const isOutOfStock = currentStock <= 0;

            let priceDisplayHtml;
            if (isSaleActive) {
                priceDisplayHtml = `
                    <div class="flex items-center">
                        <span class="text-4xl font-bold text-red-600">${CURRENCY_SYMBOL}${discountPrice.toFixed(2)}</span>
                        <span class="text-xl text-gray-500 line-through ml-4">${CURRENCY_SYMBOL}${originalPrice}</span>
                    </div>
                `;
            } else {
                priceDisplayHtml = `
                    <span class="text-4xl font-bold text-orange-600">${CURRENCY_SYMBOL}${originalPrice}</span>
                `;
            }

            const images = [product.image, product.image2, product.image3, product.image4, product.image5].filter(Boolean);
            
            const primaryImage = images.length > 0 ? images[0] : 'https://placehold.co/800x800/e2e8f0/9ca3af?text=Product+Image';
            
            let thumbnailsHtml = '';
            if (images.length > 1) {
                images.forEach((imgSrc, index) => {
                    thumbnailsHtml += `
                        <img 
                            src="${imgSrc}" 
                            alt="Thumbnail ${index + 1}" 
                            class="thumbnail-img h-16 w-16 object-cover rounded-md cursor-pointer border-2 ${index === 0 ? 'border-orange-500' : 'border-transparent hover:border-orange-500'}"
                            data-src="${imgSrc}"
                        >
                    `;
                });
            }


            detailWrapper.innerHTML = `
                <div>
                    <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden shadow-inner mb-4">
                        <img 
                            src="${primaryImage}" 
                            alt="${product.name}" 
                            class="w-full h-full object-contain p-4 transition-opacity duration-300"
                            id="main-detail-image"
                            onerror="this.onerror=null;this.src='https://placehold.co/800x800/e2e8f0/9ca3af?text=Image+Error';"
                        >
                    </div>
                    <div id="thumbnail-gallery" class="flex items-center space-x-2">
                        ${thumbnailsHtml}
                    </div>
                </div>

                <div class="flex flex-col justify-between">
                    <div>
                        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-4">${product.name}</h1>
                        
                        <div id="product-sale-timer-container" class="mb-4"></div>

                        <div class="flex items-center flex-wrap gap-x-4 gap-y-2 mb-6">
                            <div id="price-display-wrapper">
                                ${priceDisplayHtml}
                            </div>
                            <span class="text-sm font-medium text-gray-500 bg-gray-100 px-3 py-1 rounded-full">${product.category}</span>
                            <span class="font-bold ${isOutOfStock ? 'text-red-600' : 'text-green-600'}">
                                ${isOutOfStock ? 'Out of Stock' : `In Stock (${currentStock} left)`}
                            </span>
                        </div>

                        <h3 class="text-xl font-semibold text-gray-800 mb-3 border-b pb-2">Specifications</h3>
                        <div class="text-gray-700 space-y-2 mb-8 overflow-x-auto">
                            ${specsHtml}
                        </div>
                        </div>

                    <div class="mt-8 space-y-3">
                        <button id="add-to-cart-btn" 
                                data-product-id="${product.id}"
                                data-product-name="${product.name}"
                                class="w-full py-3 bg-orange-600 text-white text-lg font-semibold rounded-lg shadow-md hover:bg-orange-700 transition-colors flex items-center justify-center disabled:bg-gray-400 disabled:cursor-not-allowed"
                                ${isOutOfStock ? 'disabled' : ''}>
                            <i class="ph ph-shopping-cart text-xl mr-2"></i> ${isOutOfStock ? 'Out of Stock' : 'Add to Cart'}
                        </button>
                        <button id="buy-now-btn" 
                                data-product-id="${product.id}"
                                data-product-name="${product.name}"
                                class="w-full py-3 bg-white text-orange-600 border-2 border-orange-600 text-lg font-semibold rounded-lg shadow-md hover:bg-orange-50 transition-colors flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
                                ${isOutOfStock ? 'disabled' : ''}>
                            Buy Now
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('add-to-cart-btn').addEventListener('click', async (e) => {
                if (isOutOfStock) return; 
                
                const productId = e.currentTarget.getAttribute('data-product-id');
                const productRef = doc(db, PRODUCTS_COLLECTION_PATH, productId);
                const productSnap = await getDoc(productRef);
                
                if (productSnap.exists()) {
                    await updateCart({ id: productSnap.id, ...productSnap.data() }, 1, false, true);
                } else {
                    showModal("Error", "Product data missing for cart operation.");
                }
            });

            document.getElementById('buy-now-btn').addEventListener('click', async (e) => {
                if (isOutOfStock) return;
                
                const productId = e.currentTarget.getAttribute('data-product-id');
                const productRef = doc(db, PRODUCTS_COLLECTION_PATH, productId);
                const productSnap = await getDoc(productRef);
                
                if (productSnap.exists()) {
                    await updateCart({ id: productSnap.id, ...productSnap.data() }, 1, false, false);
                    clearListeners();
                    showCheckoutView(); 

                } else {
                    showModal("Error", "Product data missing for immediate purchase.");
                }
            });

            document.querySelectorAll('.thumbnail-img').forEach(img => {
                img.addEventListener('click', () => {
                    const mainImage = document.getElementById('main-detail-image');
                    const newSrc = img.getAttribute('data-src');
                    
                    if (mainImage && mainImage.src !== newSrc) {
                        mainImage.style.opacity = 0;
                        setTimeout(() => {
                            mainImage.src = newSrc;
                            mainImage.style.opacity = 1;
                        }, 300); 
                    }
                    
                    document.querySelectorAll('.thumbnail-img').forEach(thumb => {
                        thumb.classList.remove('border-orange-500');
                        thumb.classList.add('border-transparent');
                    });
                    img.classList.add('border-orange-500');
                    img.classList.remove('border-transparent');
                });
            });
            
            if (isSaleActive) {
                startDetailCountdown(product, saleEndTime);
            }

            document.getElementById('back-to-list-btn-detail').addEventListener('click', () => {
                if (appState === 'detail') {
                    if (currentCategory) {
                        showCategoryListing(currentCategory);
                    } else if (currentTag) {
                        showProductListing(currentTag);
                    } else {
                        renderHomeView();
                    }
                } else {
                     renderHomeView();
                }
            });
        }


        // --- Page View Functions (Policies, FAQ, About) ---

        function renderFaqView() {
            clearListeners();
            appState = 'faq';
            
            const template = document.getElementById('faq-view-template');
            if (!template) {
                console.error("FAQ view template not found!");
                return;
            }
            const clone = document.importNode(template.content, true);
            mainContentContainer.innerHTML = '';
            mainContentContainer.appendChild(clone);
            
            document.getElementById('back-to-home-btn-faq').addEventListener('click', renderHomeView);
            
            document.querySelectorAll('.faq-question').forEach(button => {
                button.addEventListener('click', () => {
                    const answer = button.nextElementSibling;
                    const plusIcon = button.querySelector('.ph-plus');
                    const minusIcon = button.querySelector('.ph-minus');

                    const isHidden = answer.classList.contains('hidden');
                    answer.classList.toggle('hidden');
                    
                    plusIcon.classList.toggle('hidden', isHidden);
                    minusIcon.classList.toggle('hidden', !isHidden);
                });
            });
        }

        function renderShippingPolicyView() {
            clearListeners();
            appState = 'shipping';
            
            const template = document.getElementById('shipping-policy-view-template');
            if (!template) {
                console.error("Shipping Policy view template not found!");
                return;
            }
            const clone = document.importNode(template.content, true);
            mainContentContainer.innerHTML = '';
            mainContentContainer.appendChild(clone);
            
            document.getElementById('back-to-home-btn-shipping').addEventListener('click', renderHomeView);
        }

        function renderReturnPolicyView() {
            clearListeners();
            appState = 'return';
            
            const template = document.getElementById('return-policy-view-template');
            if (!template) {
                console.error("Return Policy view template not found!");
                return;
            }
            const clone = document.importNode(template.content, true);
            mainContentContainer.innerHTML = '';
            mainContentContainer.appendChild(clone);
            
            document.getElementById('back-to-home-btn-return').addEventListener('click', renderHomeView);
        }

        function renderTosView() {
            clearListeners();
            appState = 'tos';
            
            const template = document.getElementById('tos-view-template');
            if (!template) {
                console.error("Terms of Service view template not found!");
                return;
            }
            const clone = document.importNode(template.content, true);
            mainContentContainer.innerHTML = '';
            mainContentContainer.appendChild(clone);
            
            document.getElementById('back-to-home-btn-tos').addEventListener('click', renderHomeView);
        }

        function renderAboutView() {
            clearListeners();
            appState = 'about';
            
            const template = document.getElementById('about-view-template');
            if (!template) {
                console.error("About Us view template not found!");
                return;
            }
            const clone = document.importNode(template.content, true);
            mainContentContainer.innerHTML = '';
            mainContentContainer.appendChild(clone);
            
            document.getElementById('back-to-home-btn-about').addEventListener('click', renderHomeView);
        }
        
        // --- END Page View Functions ---

        /**
         * Shows the custom modal.
         */
        function showModal(title, message) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('alertModal').classList.remove('hidden');
        }

        // --- Auth Modal and Firebase Auth Handlers (UPDATED) ---
        
        function showAuthModal(tab = 'login') {
            loginErrorMsg.classList.add('hidden');
            signupErrorMsg.classList.add('hidden');
            loginForm.reset();
            signupForm.reset();
            
            if (tab === 'signup') {
                authModalTitle.textContent = 'Create Account';
                tabSignup.classList.add('active');
                tabLogin.classList.remove('active');
                signupFormContent.classList.remove('hidden');
                loginFormContent.classList.add('hidden');
            } else {
                authModalTitle.textContent = 'Sign In';
                tabLogin.classList.add('active');
                tabSignup.classList.remove('active');
                loginFormContent.classList.remove('hidden');
                signupFormContent.classList.add('hidden');
            }
            
            authModal.classList.remove('hidden');
        }

        function hideAuthModal() {
            authModal.classList.add('hidden');
        }

        async function handleLogin(email, password) {
            loginErrorMsg.classList.add('hidden');
            const submitBtn = document.getElementById('login-submit-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="ph ph-spinner-gap animate-spin mr-2"></i> Signing In...';
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                
                hideAuthModal();
                showModal("Success", `Welcome back, ${email}!`);

            } catch (error) {
                let message = "An unknown error occurred during login.";
                if (error.code === 'auth/invalid-email' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    message = "Invalid email or password.";
                } else if (error.code === 'auth/too-many-requests') {
                    message = "Access temporarily blocked due to too many failed attempts. Try again later.";
                }
                
                loginErrorMsg.textContent = message;
                loginErrorMsg.classList.remove('hidden');
                console.error("Login Error:", error);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Sign In';
            }
        }

        async function handleSignUp(email, password) {
            signupErrorMsg.classList.add('hidden');
            const submitBtn = document.getElementById('signup-submit-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="ph ph-spinner-gap animate-spin mr-2"></i> Creating Account...';
            
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                
                hideAuthModal();
                showModal("Success!", `Account created for ${email}. Welcome to RareShop!`);

            } catch (error) {
                let message = "An unknown error occurred during sign up.";
                 if (error.code === 'auth/email-already-in-use') {
                    message = "This email address is already in use.";
                } else if (error.code === 'auth/invalid-email') {
                    message = "The email address is not valid.";
                } else if (error.code === 'auth/weak-password') {
                    message = "The password must be 6 characters or more.";
                }
                
                signupErrorMsg.textContent = message;
                signupErrorMsg.classList.remove('hidden');
                console.error("Sign Up Error:", error);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Create Account';
            }
        }
        
        async function handleGoogleSignIn() {
            const googleBtn = document.getElementById('google-sign-in-btn');
            if (googleBtn) {
                 googleBtn.disabled = true;
                 googleBtn.innerHTML = '<i class="ph ph-spinner-gap animate-spin mr-2"></i> Connecting...';
            }
            
            hideAuthModal(); 
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                
                showModal("Success!", `Welcome to RareShop!`);

            } catch (error) {
                let message = "Google Sign-in failed.";
                if (error.code === 'auth/popup-closed-by-user') {
                    message = "Sign-in cancelled by user.";
                } else if (error.code === 'auth/unauthorized-domain') {
                    message = "Error: Your domain 'rareservices.store' must be added to the Authorized Domains list in your Firebase settings.";
                } else if (error.code === 'auth/cancelled-popup-request') {
                    message = "Another sign-in request is already pending. Please wait.";
                } else {
                    message = `Sign-in failed: ${error.message}`;
                }
                
                console.error("Google Sign-in Error:", error);
                showModal("Sign-in Error", message);
            } finally {
                if (googleBtn) {
                    googleBtn.disabled = false;
                    googleBtn.innerHTML = '<img src="https://res.cloudinary.com/dqr2ewypl/image/upload/v1762591113/images_1_dxmcrp.png" alt="Google logo" class="w-5 h-5 mr-3">Sign in with Google';
                }
            }
        }
        
        async function handleLogout() {
            try {
                await signOut(auth);
                showModal("Logged Out", "You have been successfully logged out.");
            } catch (error) {
                console.error("Logout Error:", error);
                showModal("Logout Error", "Could not log out. Please try again.");
            }
        }

        function renderAuthStatus(user) {
            authStatusContainer.innerHTML = ''; 
            
            if (user && user.email) {
                const emailSnippet = user.email.length > 20 ? user.email.substring(0, 20) + '...' : user.email;
                authStatusContainer.innerHTML = `
                    <span class="text-sm font-medium text-gray-700 hidden sm:inline dark:text-gray-300" title="${user.email}">${emailSnippet}</span>
                    <button id="header-logout-btn" class="px-3 py-1 bg-gray-100 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-200 transition-colors dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">
                        Logout
                    </button>
                `;
                document.getElementById('header-logout-btn').addEventListener('click', handleLogout);

            } else {
                authStatusContainer.innerHTML = `
                    <a href="#" id="login-link" class="text-gray-600 hover:text-orange-600 text-sm font-medium dark:text-gray-300 dark:hover:text-orange-500">Login</a>
                    <span class="text-gray-300">|</span>
                    <a href="#" id="signup-link" class="text-gray-600 hover:text-orange-600 text-sm font-medium dark:text-gray-300 dark:hover:text-orange-500">Sign Up</a>
                `;
                document.getElementById('login-link').addEventListener('click', (e) => {
                    e.preventDefault();
                    showAuthModal('login');
                });
                document.getElementById('signup-link').addEventListener('click', (e) => {
                    e.preventDefault();
                    showAuthModal('signup');
                });
            }
        }

        // --- Initialize App and Auth ---
        
        /**
         * Initializes Firebase, authenticates the user, and sets up the initial view.
         */
        async function initializeAppAndAuth() {
            try {
                // 1. Initialize Firebase
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('debug'); 

                // ðŸ“¢ NEW: Initialize Supabase after Firebase
                initializeSupabase();

                // 2. Initial Auth Setup (Anonymously or with custom token)
                if (authTokenFromEnv) {
                    await signInWithCustomToken(auth, authTokenFromEnv);
                } else {
                    await signInAnonymously(auth);
                }

                // 3. Listen for Auth State Changes (This is the critical block)
                onAuthStateChanged(auth, (user) => {
                    loggedInUser = user;
                    
                    userId = user ? user.uid : (userIdFromEnv || crypto.randomUUID());
                    
                    userIdDisplay.textContent = `User ID (for Firestore Path): ${userId.substring(0, 8)}... | App ID: ${appId}`;
                    
                    renderAuthStatus(user);

                    if (user && user.uid) {
                        listenToCart();
                    } else {
                         cartItemCountEl.textContent = '0';
                    }
                    
                    if (appState === 'home') {
                        renderHomeView();
                    }
                });
                
                // 4. Setup Auth Modal Listeners
                authModalCloseBtn.addEventListener('click', hideAuthModal);
                
                tabLogin.addEventListener('click', () => showAuthModal('login'));
                tabSignup.addEventListener('click', () => showAuthModal('signup'));

                loginForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const email = loginForm.elements['login-email'].value;
                    const password = loginForm.elements['login-password'].value;
                    handleLogin(email, password);
                });

                signupForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const email = signupForm.elements['signup-email'].value;
                    const password = signupForm.elements['signup-password'].value;
                    handleSignUp(email, password);
                });
                
                googleSignInBtn.addEventListener('click', handleGoogleSignIn);

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showModal("Initialization Error", `Failed to initialize Firebase: ${error.message}`);
                mainContentContainer.innerHTML = '<div class="p-8 text-center text-red-500 text-xl">Initialization Error. See console.</div>';
            }
        }
        
        // --- Event Listeners ---
        document.getElementById('modalCloseBtn').addEventListener('click', () => {
            document.getElementById('alertModal').classList.add('hidden');
        });
        
        document.getElementById('logo-link').addEventListener('click', (e) => {
            e.preventDefault();
            renderHomeView();
        });
        
        document.getElementById('cart-link').addEventListener('click', (e) => {
            e.preventDefault();
            renderCartView();
        });

        document.getElementById('sidebar-track-order-link').addEventListener('click', (e) => {
            e.preventDefault();
            showTrackOrderView();
        });
        
        document.getElementById('footer-home-link').addEventListener('click', (e) => {
            e.preventDefault();
            renderHomeView();
        });

        document.getElementById('footer-shop-link').addEventListener('click', (e) => {
            e.preventDefault();
            showProductListing('featured');
        });

        document.getElementById('footer-about-link').addEventListener('click', (e) => {
            e.preventDefault();
            renderAboutView();
        });

        document.getElementById('footer-faq-link').addEventListener('click', (e) => {
            e.preventDefault();
            renderFaqView();
        });

        document.getElementById('footer-shipping-link').addEventListener('click', (e) => {
            e.preventDefault();
            renderShippingPolicyView();
        });

        document.getElementById('footer-return-link').addEventListener('click', (e) => {
            e.preventDefault();
            renderReturnPolicyView();
        });

        document.getElementById('footer-tos-link').addEventListener('click', (e) => {
            e.preventDefault();
            renderTosView();
        });

        // --- Run the App ---
        initializeAppAndAuth();

    </script>
</body>
</html>